<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenMessage</title>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #111111;
  --bg-surface: #1a1a1a;
  --bg-elevated: #242424;
  --bg-hover: #2e2e2e;
  --text-primary: #faf6f1;
  --text-secondary: #a09890;
  --text-muted: #6b6560;
  --accent: #e8a44a;
  --accent-dim: rgba(232, 164, 74, 0.15);
  --accent-glow: rgba(232, 164, 74, 0.08);
  --cream: #faf6f1;
  --cream-soft: rgba(250, 246, 241, 0.06);
  --sent-bg: #2a2520;
  --received-bg: #1e1e1e;
  --border: rgba(250, 246, 241, 0.06);
  --border-accent: rgba(232, 164, 74, 0.25);
  --radius-sm: 4px;
  --radius-md: 12px;
  --radius-lg: 20px;
  --font-serif: 'Instrument Serif', Georgia, serif;
  --font-sans: 'DM Sans', -apple-system, sans-serif;
  --shadow-soft: 0 2px 20px rgba(0,0,0,0.3);
  --shadow-glow: 0 0 40px rgba(232, 164, 74, 0.06);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  height: 100%;
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 15px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  overflow: hidden;
}

/* â”€â”€â”€ Layout â”€â”€â”€ */
.app {
  display: grid;
  grid-template-columns: 340px 1fr;
  height: 100vh;
}

/* â”€â”€â”€ Left Rail: Conversation List â”€â”€â”€ */
.sidebar {
  background: var(--bg-surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}

.sidebar-header h1 {
  font-family: var(--font-serif);
  font-size: 28px;
  font-weight: 400;
  letter-spacing: -0.5px;
  color: var(--text-primary);
}

.sidebar-header h1 span {
  color: var(--accent);
}

.new-msg-btn {
  width: 36px;
  height: 36px;
  border: none;
  background: none;
  cursor: pointer;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  transition: background 0.15s, color 0.15s;
  flex-shrink: 0;
}
.new-msg-btn:hover {
  background: var(--accent-dim);
  color: var(--accent);
}
.new-msg-btn svg {
  width: 20px;
  height: 20px;
}

/* New message overlay */
.new-msg-overlay {
  display: none;
  position: absolute;
  inset: 0;
  z-index: 50;
  background: var(--bg-surface);
  flex-direction: column;
}
.new-msg-overlay.show { display: flex; }

.new-msg-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 20px 20px 16px;
  border-bottom: 1px solid var(--border);
}
.new-msg-header h2 {
  font-family: var(--font-serif);
  font-size: 20px;
  font-weight: 400;
  flex: 1;
}
.new-msg-close {
  width: 32px;
  height: 32px;
  border: none;
  background: none;
  cursor: pointer;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  font-size: 18px;
  transition: background 0.15s;
}
.new-msg-close:hover { background: var(--cream-soft); color: var(--text-primary); }

.new-msg-input-area {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}
.new-msg-input-area label {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
  display: block;
}
.new-msg-phone {
  width: 100%;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 10px 16px;
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 15px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.new-msg-phone::placeholder { color: var(--text-muted); }
.new-msg-phone:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}
.new-msg-go {
  margin-top: 12px;
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: var(--radius-md);
  background: var(--accent);
  color: var(--bg-deep);
  font-family: var(--font-sans);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.15s;
}
.new-msg-go:hover { opacity: 0.9; }
.new-msg-go:disabled { opacity: 0.4; cursor: default; }
.new-msg-error {
  font-size: 13px;
  color: #dc503c;
  margin-top: 8px;
  display: none;
}

.search-box {
  margin: 16px 20px 12px;
  position: relative;
}

.search-box input {
  width: 100%;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 10px 16px 10px 40px;
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.search-box input::placeholder { color: var(--text-muted); }

.search-box input:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}

.search-box svg {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  width: 16px;
  height: 16px;
}

.conversation-list {
  flex: 1;
  overflow-y: auto;
  padding: 4px 8px;
}

.conversation-list::-webkit-scrollbar { width: 4px; }
.conversation-list::-webkit-scrollbar-track { background: transparent; }
.conversation-list::-webkit-scrollbar-thumb {
  background: var(--text-muted);
  border-radius: 2px;
}

.convo-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}

.convo-item:hover { background: var(--bg-hover); }

.convo-item.active {
  background: var(--accent-dim);
}

.convo-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 3px;
  height: 28px;
  background: var(--accent);
  border-radius: 0 2px 2px 0;
}

.convo-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-sans);
  font-size: 17px;
  font-weight: 600;
  color: #ffffff;
  flex-shrink: 0;
  border: none;
  letter-spacing: 0.5px;
}

.convo-item.active .convo-avatar {
  box-shadow: 0 0 0 2px var(--bg-surface), 0 0 0 4px var(--border-accent);
}

.convo-meta {
  flex: 1;
  min-width: 0;
}

.convo-name {
  font-family: var(--font-serif);
  font-size: 16px;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.convo-preview {
  font-size: 13px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 2px;
}

.convo-time {
  font-size: 11px;
  color: var(--text-muted);
  flex-shrink: 0;
  align-self: flex-start;
  margin-top: 2px;
}

.convo-unread {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  border-radius: 10px;
  background: var(--accent);
  color: var(--bg-deep);
  font-size: 11px;
  font-weight: 700;
  font-family: var(--font-sans);
  flex-shrink: 0;
  align-self: center;
}

.convo-item.unread .convo-name {
  font-weight: 600;
  color: var(--cream);
}

.convo-item.unread .convo-preview {
  color: var(--text-primary);
  font-weight: 500;
}

/* â”€â”€â”€ Right Pane: Messages â”€â”€â”€ */
.chat-pane {
  display: flex;
  flex-direction: column;
  background: var(--bg-deep);
  overflow: hidden;
}

.chat-header {
  padding: 20px 28px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  display: flex;
  align-items: center;
  gap: 14px;
}

.chat-header-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-sans);
  font-size: 15px;
  font-weight: 600;
  color: #ffffff;
  flex-shrink: 0;
  border: none;
}

.chat-header-name {
  font-family: var(--font-serif);
  font-size: 20px;
  font-weight: 400;
}

.chat-header-status {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 1px;
}

.messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 24px 28px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.messages-area::-webkit-scrollbar { width: 4px; }
.messages-area::-webkit-scrollbar-track { background: transparent; }
.messages-area::-webkit-scrollbar-thumb {
  background: rgba(250, 246, 241, 0.1);
  border-radius: 2px;
}

.msg {
  max-width: 520px;
  padding: 10px 16px;
  border-radius: var(--radius-lg);
  font-size: 14.5px;
  line-height: 1.55;
  animation: msgIn 0.25s ease-out;
  position: relative;
  overflow: visible;
}

@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.sent {
  align-self: flex-end;
  background: var(--sent-bg);
  color: var(--cream);
  border-bottom-right-radius: var(--radius-sm);
  border: 1px solid rgba(232, 164, 74, 0.12);
}

.msg.received {
  align-self: flex-start;
  background: var(--received-bg);
  color: var(--text-primary);
  border-bottom-left-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

/* â”€â”€â”€ Message Avatar (group chats) â”€â”€â”€ */
.msg-row {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  max-width: 560px;
  animation: msgIn 0.25s ease-out;
}

.msg-row.sent {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.msg-row.received {
  align-self: flex-start;
}

.msg-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-sans);
  font-size: 11px;
  font-weight: 600;
  color: #ffffff;
  flex-shrink: 0;
  margin-bottom: 2px;
}

.msg-avatar.avatar-hidden {
  visibility: hidden;
}

.msg-row .msg {
  align-self: auto;
  animation: none;
  min-width: 0;
}

.msg-sender {
  font-size: 12px;
  font-weight: 500;
  color: var(--accent);
  margin-bottom: 3px;
  font-family: var(--font-sans);
}

.msg-time {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
  text-align: right;
}

.msg.sent .msg-time { color: rgba(250, 246, 241, 0.35); }

/* â”€â”€â”€ Message Status Indicators â”€â”€â”€ */
.msg-status {
  display: inline-block;
  margin-left: 4px;
  font-size: 11px;
  vertical-align: middle;
  line-height: 1;
}

.msg-status.status-sending {
  color: rgba(250, 246, 241, 0.35);
  font-size: 10px;
}

.msg-status.status-sent {
  color: rgba(250, 246, 241, 0.35);
}

.msg-status.status-delivered {
  color: rgba(250, 246, 241, 0.45);
}

.msg-status.status-read {
  color: var(--accent);
}

.msg-status.status-failed {
  color: #dc503c;
  font-size: 10px;
}

/* â”€â”€â”€ Media (images & videos) â”€â”€â”€ */
.msg-media {
  margin: 4px 0;
  position: relative;
  border-radius: var(--radius-md);
  overflow: hidden;
  max-width: 320px;
}

.msg.sent .msg-media { margin-left: auto; }

.msg-media img {
  max-width: 100%;
  max-height: 300px;
  border-radius: var(--radius-md);
  cursor: pointer;
  display: block;
  background: var(--bg-elevated);
  min-height: 60px;
  object-fit: cover;
}

.msg-media video {
  max-width: 100%;
  max-height: 300px;
  border-radius: var(--radius-md);
  display: block;
  background: #000;
  object-fit: cover;
}

/* Legacy class compat */
.msg-image {
  max-width: 320px;
  max-height: 400px;
  border-radius: var(--radius-md);
  margin: 4px 0;
  cursor: pointer;
  display: block;
  background: var(--bg-elevated);
  min-height: 80px;
  object-fit: contain;
}

.msg-image-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 200px;
  height: 120px;
  border-radius: var(--radius-md);
  background: var(--bg-elevated);
  color: var(--text-muted);
  font-size: 12px;
  margin: 4px 0;
}

.msg-media-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 200px;
  height: 120px;
  border-radius: var(--radius-md);
  background: var(--bg-elevated);
  color: var(--text-muted);
  font-size: 12px;
  margin: 4px 0;
}

.msg-media-loading .spinner {
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.msg.sent .msg-image { margin-left: auto; }

.msg-image-fullscreen {
  position: fixed;
  inset: 0;
  z-index: 100;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: zoom-out;
}

.msg-image-fullscreen img {
  max-width: 90vw;
  max-height: 90vh;
  object-fit: contain;
  border-radius: var(--radius-md);
}

.msg-image-fullscreen video {
  max-width: 90vw;
  max-height: 90vh;
  object-fit: contain;
  border-radius: var(--radius-md);
}

.msg-image-fullscreen .fullscreen-close {
  position: absolute;
  top: 20px;
  right: 24px;
  background: none;
  border: none;
  color: #fff;
  font-size: 32px;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.15s;
  line-height: 1;
}

.msg-image-fullscreen .fullscreen-close:hover {
  opacity: 1;
}

/* â”€â”€â”€ Reactions â”€â”€â”€ */
.msg-reactions {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  position: absolute;
  bottom: -12px;
  left: 12px;
  z-index: 2;
}

.msg.sent .msg-reactions {
  left: auto;
  right: 12px;
}

.msg:has(.msg-reactions) {
  margin-bottom: 18px;
}

.reaction-pill {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  padding: 1px 6px;
  border-radius: 10px;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  font-size: 14px;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  line-height: 1.4;
}

.reaction-pill:hover {
  background: var(--accent-dim);
  border-color: var(--border-accent);
}

.reaction-pill .reaction-count {
  font-size: 10px;
  color: var(--text-muted);
}

/* â”€â”€â”€ Message Hover Action Bar (Google Messages style) â”€â”€â”€ */
.msg-actions {
  position: absolute;
  top: -16px;
  display: none;
  align-items: center;
  gap: 2px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 2px 4px;
  box-shadow: var(--shadow-soft);
  z-index: 20;
}

.msg.sent .msg-actions { right: 8px; }
.msg.received .msg-actions { left: 8px; }

.msg:hover .msg-actions { display: flex; }

.msg-actions button {
  background: none;
  border: none;
  font-size: 16px;
  width: 32px;
  height: 32px;
  cursor: pointer;
  border-radius: 50%;
  transition: background 0.1s;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
}

.msg-actions button:hover {
  background: var(--accent-dim);
}

.msg-actions button svg {
  width: 16px;
  height: 16px;
}

/* â”€â”€â”€ Emoji Picker (expanded from action bar) â”€â”€â”€ */
.emoji-picker {
  position: absolute;
  bottom: calc(100% + 4px);
  display: none;
  align-items: center;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 4px 6px;
  gap: 0;
  box-shadow: var(--shadow-soft);
  z-index: 30;
}

.emoji-picker.show { display: flex; }

.msg.sent .emoji-picker { right: 0; }
.msg.received .emoji-picker { left: 0; }

.emoji-picker button {
  background: none;
  border: none;
  font-size: 22px;
  padding: 4px 5px;
  cursor: pointer;
  border-radius: 50%;
  transition: background 0.15s, transform 0.15s;
  line-height: 1;
}

.emoji-picker button:hover {
  background: var(--accent-dim);
  transform: scale(1.2);
}

.emoji-picker .emoji-plus {
  font-size: 18px;
  font-weight: 300;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-hover);
  border-radius: 50%;
  color: var(--text-secondary);
  margin-left: 2px;
  padding: 0;
}
.emoji-picker .emoji-plus:hover {
  background: var(--accent-dim);
  transform: scale(1.1);
}

/* Full emoji grid panel */
.emoji-full-panel {
  position: absolute;
  bottom: calc(100% + 4px);
  display: none;
  flex-direction: column;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-soft);
  z-index: 31;
  width: 320px;
  max-height: 360px;
}
.emoji-full-panel.show { display: flex; }
.msg.sent .emoji-full-panel { right: 0; }
.msg.received .emoji-full-panel { left: 0; }

.emoji-full-panel .emoji-search {
  padding: 8px;
  border-bottom: 1px solid var(--border);
}
.emoji-full-panel .emoji-search input {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  outline: none;
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: var(--font-sans);
}
.emoji-full-panel .emoji-search input:focus {
  border-color: var(--border-accent);
}
.emoji-full-panel .emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 2px;
  padding: 8px;
  overflow-y: auto;
  flex: 1;
}
.emoji-full-panel .emoji-grid button {
  background: none;
  border: none;
  font-size: 24px;
  padding: 4px;
  cursor: pointer;
  border-radius: 6px;
  line-height: 1;
  text-align: center;
}
.emoji-full-panel .emoji-grid button:hover {
  background: var(--accent-dim);
  transform: scale(1.15);
}
.emoji-full-panel .emoji-cat-label {
  grid-column: 1 / -1;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 6px 2px 2px;
}

/* â”€â”€â”€ Reply Preview (quoted message inside bubble) â”€â”€â”€ */
.msg-reply-preview {
  padding: 6px 10px;
  margin-bottom: 6px;
  border-left: 3px solid var(--text-muted);
  border-radius: 6px;
  background: rgba(255, 255, 255, 0.04);
  font-size: 12.5px;
  line-height: 1.4;
  color: var(--text-secondary);
  cursor: pointer;
  max-width: 100%;
  overflow: hidden;
  transition: background 0.15s;
}

.msg-reply-preview:hover {
  background: rgba(255, 255, 255, 0.08);
}

.msg.sent .msg-reply-preview {
  border-left-color: var(--accent);
  background: rgba(232, 164, 74, 0.08);
}

.msg.sent .msg-reply-preview:hover {
  background: rgba(232, 164, 74, 0.14);
}

.msg-reply-preview .reply-author {
  display: block;
  font-size: 11.5px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 1px;
}

.msg.received .msg-reply-preview .reply-author {
  color: var(--text-secondary);
}

.msg-reply-preview .reply-body {
  display: block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text-muted);
  font-size: 12px;
}

/* â”€â”€â”€ Reply Compose Indicator â”€â”€â”€ */
.reply-indicator {
  display: none;
  padding: 8px 16px;
  background: var(--bg-elevated);
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  color: var(--text-secondary);
  align-items: center;
  gap: 8px;
}

.reply-indicator.show { display: flex; }

.reply-indicator .reply-preview {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.reply-indicator .reply-preview span {
  color: var(--accent);
  font-weight: 500;
}

.reply-indicator .reply-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 16px;
  padding: 2px 6px;
  border-radius: 4px;
}

.reply-indicator .reply-close:hover {
  background: var(--cream-soft);
  color: var(--text-primary);
}

.date-divider {
  text-align: center;
  padding: 16px 0 8px;
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.system-msg {
  text-align: center;
  padding: 8px 20px;
  font-size: 12px;
  color: var(--text-muted);
  font-style: italic;
  animation: msgIn 0.25s ease-out;
}

/* â”€â”€â”€ Compose Bar â”€â”€â”€ */
.compose-bar {
  padding: 16px 28px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg-surface);
  display: flex;
  gap: 12px;
  align-items: flex-end;
}

.compose-input {
  flex: 1;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 12px 18px;
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 14.5px;
  line-height: 1.5;
  outline: none;
  resize: none;
  min-height: 44px;
  max-height: 160px;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.compose-input::placeholder { color: var(--text-muted); }

.compose-input:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}

.send-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s, opacity 0.15s;
  flex-shrink: 0;
}

.send-btn:hover { transform: scale(1.06); }
.send-btn:active { transform: scale(0.95); }
.send-btn:disabled { opacity: 0.3; cursor: default; transform: none; }

.send-btn svg {
  width: 20px;
  height: 20px;
  color: var(--bg-deep);
}

/* â”€â”€â”€ Attachment Preview â”€â”€â”€ */
.attach-preview {
  display: none;
  padding: 8px 28px 0;
  border-top: 1px solid var(--border);
  background: var(--bg-surface);
}
.attach-preview.active { display: flex; align-items: center; gap: 10px; }
.attach-preview img {
  max-height: 80px;
  max-width: 120px;
  border-radius: var(--radius-sm);
  object-fit: cover;
}
.attach-preview .attach-name {
  font-size: 12px;
  color: var(--text-secondary);
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.attach-preview .attach-remove {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  padding: 4px 8px;
}
.attach-preview .attach-remove:hover { color: var(--text-primary); }

.attach-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: none;
  border: 1px solid var(--border);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: border-color 0.2s, background 0.2s;
}
.attach-btn:hover {
  border-color: var(--border-accent);
  background: var(--accent-dim);
}
.attach-btn svg {
  width: 20px;
  height: 20px;
  color: var(--text-secondary);
}

/* â”€â”€â”€ Empty State â”€â”€â”€ */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: var(--text-muted);
}

.empty-state-icon {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: var(--accent-dim);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 8px;
}

.empty-state-icon svg {
  width: 28px;
  height: 28px;
  color: var(--accent);
}

.empty-state h2 {
  font-family: var(--font-serif);
  font-size: 22px;
  color: var(--text-secondary);
  font-weight: 400;
}

.empty-state p {
  font-size: 14px;
  color: var(--text-muted);
  max-width: 280px;
  text-align: center;
}

/* â”€â”€â”€ Connection Banner â”€â”€â”€ */
.connection-banner {
  padding: 8px 20px;
  background: var(--accent-dim);
  border-bottom: 1px solid var(--border-accent);
  font-size: 13px;
  color: var(--accent);
  text-align: center;
  display: none;
}

.connection-banner.disconnected {
  display: block;
  background: rgba(220, 80, 60, 0.12);
  border-color: rgba(220, 80, 60, 0.25);
  color: #dc503c;
}

/* â”€â”€â”€ Responsive â”€â”€â”€ */
@media (max-width: 768px) {
  .app { grid-template-columns: 1fr; }
  .sidebar { display: none; }
  .sidebar.mobile-open { display: flex; position: fixed; inset: 0; z-index: 10; }
}

/* â”€â”€â”€ Light Mode â”€â”€â”€ */
@media (prefers-color-scheme: light) {
  :root {
    --bg-deep: #f5f3f0;
    --bg-surface: #ffffff;
    --bg-elevated: #eae7e3;
    --bg-hover: #e2dfdb;
    --text-primary: #1a1816;
    --text-secondary: #5c5650;
    --text-muted: #9a948e;
    --accent: #d4922e;
    --accent-dim: rgba(212, 146, 46, 0.12);
    --accent-glow: rgba(212, 146, 46, 0.06);
    --cream: #1a1816;
    --cream-soft: rgba(26, 24, 22, 0.05);
    --sent-bg: #fdf4e7;
    --received-bg: #ffffff;
    --border: rgba(26, 24, 22, 0.1);
    --border-accent: rgba(212, 146, 46, 0.35);
    --shadow-soft: 0 2px 20px rgba(0,0,0,0.08);
    --shadow-glow: 0 0 40px rgba(212, 146, 46, 0.08);
  }

  /* Scrollbar thumbs */
  .conversation-list::-webkit-scrollbar-thumb {
    background: rgba(26, 24, 22, 0.2);
  }

  .messages-area::-webkit-scrollbar-thumb {
    background: rgba(26, 24, 22, 0.15);
  }

  /* Sent message border override (hard-coded in dark mode) */
  .msg.sent {
    border-color: rgba(212, 146, 46, 0.2);
  }

  /* Sent message time color */
  .msg.sent .msg-time {
    color: rgba(26, 24, 22, 0.4);
  }

  /* Send button icon color */
  .send-btn svg {
    color: #ffffff;
  }

  /* Fullscreen overlay slightly lighter backdrop */
  .msg-image-fullscreen {
    background: rgba(0, 0, 0, 0.75);
  }

  /* Reaction pill background uses a light surface */
  .reaction-pill {
    background: var(--bg-surface);
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  }

  /* Disconnection banner: soften red tones for light mode */
  .connection-banner.disconnected {
    background: rgba(220, 80, 60, 0.08);
    border-color: rgba(220, 80, 60, 0.2);
  }

  /* Reply preview: use dark-based tints for light mode */
  .msg-reply-preview {
    background: rgba(0, 0, 0, 0.04);
  }

  .msg-reply-preview:hover {
    background: rgba(0, 0, 0, 0.07);
  }

  .msg.sent .msg-reply-preview {
    background: rgba(212, 146, 46, 0.1);
  }

  .msg.sent .msg-reply-preview:hover {
    background: rgba(212, 146, 46, 0.16);
  }
}
</style>
</head>
<body>

<div class="app" id="app">
  <!-- Left Rail -->
  <div class="sidebar" id="sidebar" style="position:relative">
    <div class="sidebar-header" style="display:flex;align-items:center;justify-content:space-between">
      <h1>Open<span>Message</span></h1>
      <button class="new-msg-btn" id="new-msg-btn" title="New message">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      </button>
    </div>
    <div class="search-box">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="search-input" placeholder="Search messages..." autocomplete="off">
    </div>
    <div class="conversation-list" id="conversation-list"></div>

    <!-- New message overlay -->
    <div class="new-msg-overlay" id="new-msg-overlay">
      <div class="new-msg-header">
        <h2>New message</h2>
        <button class="new-msg-close" id="new-msg-close">&times;</button>
      </div>
      <div class="new-msg-input-area">
        <label>To</label>
        <input type="tel" class="new-msg-phone" id="new-msg-phone" placeholder="+1 555 123 4567" autocomplete="off">
        <button class="new-msg-go" id="new-msg-go">Start conversation</button>
        <div class="new-msg-error" id="new-msg-error"></div>
      </div>
    </div>
  </div>

  <!-- Right Pane -->
  <div class="chat-pane" id="chat-pane">
    <div class="connection-banner" id="connection-banner">
      Not connected to Google Messages
    </div>

    <!-- Empty state (shown when no conversation selected) -->
    <div class="empty-state" id="empty-state">
      <div class="empty-state-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <h2>Your messages</h2>
      <p>Select a conversation to start messaging, or wait for new messages to arrive.</p>
    </div>

    <!-- Chat view (hidden until conversation selected) -->
    <div class="chat-header" id="chat-header" style="display:none">
      <div class="chat-header-avatar" id="chat-header-avatar"></div>
      <div>
        <div class="chat-header-name" id="chat-header-name"></div>
        <div class="chat-header-status" id="chat-header-status"></div>
      </div>
    </div>
    <div class="messages-area" id="messages-area" style="display:none"></div>
    <div class="reply-indicator" id="reply-indicator">
      <div class="reply-preview">Replying to <span id="reply-to-name"></span>: <span id="reply-to-text"></span></div>
      <button class="reply-close" id="reply-close">&times;</button>
    </div>
    <div class="attach-preview" id="attach-preview">
      <img id="attach-thumb" alt="Preview">
      <span class="attach-name" id="attach-name"></span>
      <button class="attach-remove" id="attach-remove">&times;</button>
    </div>
    <div class="compose-bar" id="compose-bar" style="display:none">
      <input type="file" id="file-input" accept="image/*,video/*" style="display:none">
      <button class="attach-btn" id="attach-btn" title="Attach image">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      </button>
      <textarea class="compose-input" id="compose-input" placeholder="Write a message..." rows="1"></textarea>
      <button class="send-btn" id="send-btn" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const API = '';
  let activeConvoId = null;
  let conversations = [];
  let pollTimer = null;

  // â”€â”€â”€ DOM refs â”€â”€â”€
  const $convoList = document.getElementById('conversation-list');
  const $emptyState = document.getElementById('empty-state');
  const $chatHeader = document.getElementById('chat-header');
  const $chatHeaderAvatar = document.getElementById('chat-header-avatar');
  const $chatHeaderName = document.getElementById('chat-header-name');
  const $chatHeaderStatus = document.getElementById('chat-header-status');
  const $messagesArea = document.getElementById('messages-area');
  const $composeBar = document.getElementById('compose-bar');
  const $composeInput = document.getElementById('compose-input');
  const $sendBtn = document.getElementById('send-btn');
  const $fileInput = document.getElementById('file-input');
  const $attachBtn = document.getElementById('attach-btn');
  const $attachPreview = document.getElementById('attach-preview');
  const $attachThumb = document.getElementById('attach-thumb');
  const $attachName = document.getElementById('attach-name');
  const $attachRemove = document.getElementById('attach-remove');
  let pendingFile = null; // { file: File, dataUrl: string }
  const $searchInput = document.getElementById('search-input');
  const $connectionBanner = document.getElementById('connection-banner');
  const $replyIndicator = document.getElementById('reply-indicator');
  const $replyToName = document.getElementById('reply-to-name');
  const $replyToText = document.getElementById('reply-to-text');
  const $replyClose = document.getElementById('reply-close');

  const $newMsgBtn = document.getElementById('new-msg-btn');
  const $newMsgOverlay = document.getElementById('new-msg-overlay');
  const $newMsgClose = document.getElementById('new-msg-close');
  const $newMsgPhone = document.getElementById('new-msg-phone');
  const $newMsgGo = document.getElementById('new-msg-go');
  const $newMsgError = document.getElementById('new-msg-error');

  let replyToMsg = null; // {MessageID, SenderName, Body}
  const QUICK_EMOJIS = ['ğŸ˜‚', 'â¤ï¸', 'ğŸ‘', 'ğŸ‘', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ˜¡', 'ğŸ™', 'ğŸ”¥', 'ğŸ‰', 'ğŸ‘€', 'ğŸ’¯'];

  // Full emoji dataset by category
  const EMOJI_CATEGORIES = [
    { name: 'Smileys', emojis: ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','ğŸ˜š','ğŸ˜™','ğŸ¥²','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ«¡','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ«¥','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ¥¸','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ«¤','ğŸ˜Ÿ','ğŸ™','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ¥¹','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–'] },
    { name: 'Gestures', emojis: ['ğŸ‘‹','ğŸ¤š','ğŸ–ï¸','âœ‹','ğŸ––','ğŸ«±','ğŸ«²','ğŸ«³','ğŸ«´','ğŸ‘Œ','ğŸ¤Œ','ğŸ¤','âœŒï¸','ğŸ¤','ğŸ«°','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ–•','ğŸ‘‡','â˜ï¸','ğŸ«µ','ğŸ‘','ğŸ‘','âœŠ','ğŸ‘Š','ğŸ¤›','ğŸ¤œ','ğŸ‘','ğŸ™Œ','ğŸ«¶','ğŸ‘','ğŸ¤²','ğŸ¤','ğŸ™','âœï¸','ğŸ’…','ğŸ¤³','ğŸ’ª','ğŸ¦¾','ğŸ¦¿'] },
    { name: 'Hearts', emojis: ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â¤ï¸â€ğŸ”¥','â¤ï¸â€ğŸ©¹','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ'] },
    { name: 'Animals', emojis: ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ»â€â„ï¸','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ£','ğŸ¥','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸª±','ğŸ›','ğŸ¦‹','ğŸŒ','ğŸ','ğŸœ','ğŸª°','ğŸª²','ğŸª³','ğŸ¦Ÿ','ğŸ¦—','ğŸ•·ï¸','ğŸ¦‚','ğŸ¢','ğŸ','ğŸ¦','ğŸ¦–','ğŸ¦•','ğŸ™','ğŸ¦‘','ğŸ¦','ğŸ¦','ğŸ¦€','ğŸ¡','ğŸ ','ğŸŸ','ğŸ¬','ğŸ³','ğŸ‹','ğŸ¦ˆ','ğŸª¸','ğŸŠ','ğŸ…','ğŸ†','ğŸ¦“','ğŸ¦','ğŸ¦§','ğŸ˜','ğŸ¦›','ğŸ¦','ğŸª','ğŸ«','ğŸ¦’','ğŸ¦˜','ğŸ¦¬','ğŸƒ','ğŸ‚','ğŸ„','ğŸ','ğŸ–','ğŸ','ğŸ‘','ğŸ¦™','ğŸ','ğŸ¦Œ','ğŸ•','ğŸ©','ğŸ¦®','ğŸ•â€ğŸ¦º','ğŸˆ','ğŸˆâ€â¬›','ğŸª¶','ğŸ“','ğŸ¦ƒ','ğŸ¦¤','ğŸ¦š','ğŸ¦œ','ğŸ¦¢','ğŸ¦©','ğŸ•Šï¸','ğŸ‡','ğŸ¦','ğŸ¦¨','ğŸ¦¡','ğŸ¦«','ğŸ¦¦','ğŸ¦¥','ğŸ','ğŸ€','ğŸ¿ï¸','ğŸ¦”'] },
    { name: 'Food', emojis: ['ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸ«','ğŸˆ','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥¥','ğŸ¥','ğŸ…','ğŸ†','ğŸ¥‘','ğŸ¥¦','ğŸ¥¬','ğŸ¥’','ğŸŒ¶ï¸','ğŸ«‘','ğŸŒ½','ğŸ¥•','ğŸ«’','ğŸ§„','ğŸ§…','ğŸ¥”','ğŸ ','ğŸ«˜','ğŸ¥','ğŸ¥–','ğŸ','ğŸ¥¨','ğŸ¥¯','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ§ˆ','ğŸ¥','ğŸ§‡','ğŸ¥“','ğŸ¥©','ğŸ—','ğŸ–','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ•','ğŸ«“','ğŸ¥ª','ğŸ¥™','ğŸ§†','ğŸŒ®','ğŸŒ¯','ğŸ«”','ğŸ¥—','ğŸ¥˜','ğŸ«•','ğŸ¥«','ğŸ','ğŸœ','ğŸ²','ğŸ›','ğŸ£','ğŸ±','ğŸ¥Ÿ','ğŸ¦ª','ğŸ¤','ğŸ™','ğŸš','ğŸ˜','ğŸ¥','ğŸ¥ ','ğŸ¥®','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ¥§','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥›','ğŸ¼','ğŸ«–','â˜•','ğŸµ','ğŸ§ƒ','ğŸ¥¤','ğŸ§‹','ğŸ¶','ğŸº','ğŸ»','ğŸ¥‚','ğŸ·','ğŸ¥ƒ','ğŸ¸','ğŸ¹','ğŸ§‰','ğŸ¾','ğŸ§Š','ğŸ¥„','ğŸ´','ğŸ½ï¸','ğŸ¥£','ğŸ¥¡','ğŸ¥¢'] },
    { name: 'Activities', emojis: ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸª€','ğŸ“','ğŸ¸','ğŸ’','ğŸ‘','ğŸ¥','ğŸ','ğŸªƒ','ğŸ¥…','â›³','ğŸª','ğŸ¹','ğŸ£','ğŸ¤¿','ğŸ¥Š','ğŸ¥‹','ğŸ½','ğŸ›¹','ğŸ›¼','ğŸ›·','â›¸ï¸','ğŸ¥Œ','ğŸ¿','â›·ï¸','ğŸ‚','ğŸª‚','ğŸ‹ï¸','ğŸ¤¼','ğŸ¤¸','â›¹ï¸','ğŸ¤º','ğŸ¤¾','ğŸŒï¸','ğŸ‡','ğŸ§˜','ğŸ„','ğŸŠ','ğŸ¤½','ğŸš£','ğŸ§—','ğŸšµ','ğŸš´','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…','ğŸ–ï¸','ğŸµï¸','ğŸ—ï¸','ğŸª','ğŸ­','ğŸ¨','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¼','ğŸ¹','ğŸ¥','ğŸª˜','ğŸ·','ğŸº','ğŸª—','ğŸ¸','ğŸª•','ğŸ»','ğŸ²','â™Ÿï¸','ğŸ¯','ğŸ³','ğŸ®','ğŸ•¹ï¸','ğŸ§©'] },
    { name: 'Travel', emojis: ['ğŸš—','ğŸš•','ğŸš™','ğŸšŒ','ğŸš','ğŸï¸','ğŸš“','ğŸš‘','ğŸš’','ğŸš','ğŸ›»','ğŸšš','ğŸš›','ğŸšœ','ğŸï¸','ğŸ›µ','ğŸš²','ğŸ›´','ğŸ›º','ğŸšƒ','ğŸš‹','ğŸš','ğŸš','ğŸš…','ğŸš†','ğŸš‡','ğŸšŠ','ğŸš‰','âœˆï¸','ğŸ›«','ğŸ›¬','ğŸ›©ï¸','ğŸ’º','ğŸ›°ï¸','ğŸš€','ğŸ›¸','ğŸš','ğŸ›¶','â›µ','ğŸš¤','ğŸ›¥ï¸','ğŸ›³ï¸','â›´ï¸','ğŸš¢','ğŸ—¼','ğŸ°','ğŸ¯','ğŸŸï¸','ğŸ¡','ğŸ¢','ğŸ ','â›²','â›±ï¸','ğŸ–ï¸','ğŸï¸','ğŸœï¸','ğŸŒ‹','â›°ï¸','ğŸ”ï¸','ğŸ—»','ğŸ•ï¸','ğŸ›–','ğŸ ','ğŸ¡','ğŸ˜ï¸','ğŸšï¸','ğŸ—ï¸','ğŸ­','ğŸ¢','ğŸ¬','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ¨','ğŸª','ğŸ«','ğŸ©','ğŸ’’','ğŸ›ï¸','â›ª','ğŸ•Œ','ğŸ•','ğŸ›•','ğŸ•‹','â›©ï¸','ğŸ—¾','ğŸ‘','ğŸï¸','ğŸŒ…','ğŸŒ„','ğŸŒ ','ğŸ†','ğŸ‡','ğŸŒ‡','ğŸŒ†','ğŸ™ï¸','ğŸŒƒ','ğŸŒŒ','ğŸŒ‰','ğŸŒ'] },
    { name: 'Objects', emojis: ['âŒš','ğŸ“±','ğŸ’»','âŒ¨ï¸','ğŸ–¥ï¸','ğŸ–¨ï¸','ğŸ–±ï¸','ğŸ–²ï¸','ğŸ’¾','ğŸ’¿','ğŸ“€','ğŸ“·','ğŸ“¸','ğŸ“¹','ğŸ¥','ğŸ“½ï¸','ğŸï¸','ğŸ“','â˜ï¸','ğŸ“Ÿ','ğŸ“ ','ğŸ“º','ğŸ“»','ğŸ™ï¸','ğŸšï¸','ğŸ›ï¸','ğŸ§­','â±ï¸','â²ï¸','â°','ğŸ•°ï¸','âŒ›','â³','ğŸ“¡','ğŸ”‹','ğŸª«','ğŸ”Œ','ğŸ’¡','ğŸ”¦','ğŸ•¯ï¸','ğŸ§¯','ğŸ›¢ï¸','ğŸ’¸','ğŸ’µ','ğŸ’´','ğŸ’¶','ğŸ’·','ğŸª™','ğŸ’°','ğŸ’³','ğŸªª','ğŸ’','âš–ï¸','ğŸªœ','ğŸ§°','ğŸª›','ğŸ”§','ğŸ”¨','âš’ï¸','ğŸ› ï¸','â›ï¸','ğŸªš','ğŸ”©','âš™ï¸','ğŸª¤','ğŸ§±','â›“ï¸','ğŸ§²','ğŸ”«','ğŸ’£','ğŸ§¨','ğŸª“','ğŸ”ª','ğŸ—¡ï¸','âš”ï¸','ğŸ›¡ï¸','ğŸš¬','âš°ï¸','ğŸª¦','âš±ï¸','ğŸº','ğŸ”®','ğŸ“¿','ğŸ§¿','ğŸª¬','ğŸ’ˆ','âš—ï¸','ğŸ”­','ğŸ”¬','ğŸ•³ï¸','ğŸ©¹','ğŸ©º','ğŸ©»','ğŸ©¼','ğŸ’Š','ğŸ’‰','ğŸ©¸','ğŸ§¬','ğŸ¦ ','ğŸ§«','ğŸ§ª','ğŸŒ¡ï¸','ğŸ§¹','ğŸª ','ğŸ§º','ğŸ§»','ğŸš½','ğŸš°','ğŸš¿','ğŸ›','ğŸ›€','ğŸ§¼','ğŸª¥','ğŸª’','ğŸ§½','ğŸª£','ğŸ§´','ğŸ›ï¸','ğŸ”‘','ğŸ—ï¸','ğŸšª','ğŸª‘','ğŸ›‹ï¸','ğŸ›ï¸','ğŸ›Œ','ğŸ§¸','ğŸª†','ğŸ–¼ï¸','ğŸª','ğŸªŸ','ğŸ›ï¸','ğŸ›’','ğŸ','ğŸˆ','ğŸ','ğŸ€','ğŸª„','ğŸª…','ğŸŠ','ğŸ‰','ğŸ','ğŸ','ğŸ§§','âœ‰ï¸','ğŸ“©','ğŸ“¨','ğŸ“§','ğŸ’Œ','ğŸ“¥','ğŸ“¤','ğŸ“¦','ğŸ·ï¸','ğŸª§','ğŸ“ª','ğŸ“«','ğŸ“¬','ğŸ“­','ğŸ“®','ğŸ“¯','ğŸ“œ','ğŸ“ƒ','ğŸ“„','ğŸ“‘','ğŸ§¾','ğŸ“Š','ğŸ“ˆ','ğŸ“‰','ğŸ—’ï¸','ğŸ—“ï¸','ğŸ“†','ğŸ“…','ğŸ—‘ï¸','ğŸ“‡','ğŸ—ƒï¸','ğŸ—³ï¸','ğŸ—„ï¸','ğŸ“‹','ğŸ“','ğŸ“‚','ğŸ—‚ï¸','ğŸ—ï¸','ğŸ“°','ğŸ““','ğŸ“”','ğŸ“’','ğŸ“•','ğŸ“—','ğŸ“˜','ğŸ“™','ğŸ“š','ğŸ“–','ğŸ”–','ğŸ§·','ğŸ”—','ğŸ“','ğŸ–‡ï¸','ğŸ“','ğŸ“','ğŸ§®','ğŸ“Œ','ğŸ“','âœ‚ï¸','ğŸ–Šï¸','ğŸ–‹ï¸','âœ’ï¸','ğŸ–Œï¸','ğŸ–ï¸','ğŸ“','âœï¸','ğŸ”','ğŸ”','ğŸ”','ğŸ”','ğŸ”’','ğŸ”“'] },
    { name: 'Symbols', emojis: ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ğŸ•‰ï¸','â˜¸ï¸','âœ¡ï¸','ğŸ”¯','ğŸ•','â˜¯ï¸','â˜¦ï¸','ğŸ›','â›','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','ğŸ†”','âš›ï¸','ğŸ‰‘','â˜¢ï¸','â˜£ï¸','ğŸ“´','ğŸ“³','ğŸˆ¶','ğŸˆš','ğŸˆ¸','ğŸˆº','ğŸˆ·ï¸','âœ´ï¸','ğŸ†š','ğŸ’®','ğŸ‰','ãŠ™ï¸','ãŠ—ï¸','ğŸˆ´','ğŸˆµ','ğŸˆ¹','ğŸˆ²','ğŸ…°ï¸','ğŸ…±ï¸','ğŸ†','ğŸ†‘','ğŸ…¾ï¸','ğŸ†˜','âŒ','â­•','ğŸ›‘','â›”','ğŸ“›','ğŸš«','ğŸ’¯','ğŸ’¢','â™¨ï¸','ğŸš·','ğŸš¯','ğŸš³','ğŸš±','ğŸ”','ğŸ“µ','ğŸš­','â—','â•','â“','â”','â€¼ï¸','â‰ï¸','ğŸ”…','ğŸ”†','ã€½ï¸','âš ï¸','ğŸš¸','ğŸ”±','âšœï¸','ğŸ”°','â™»ï¸','âœ…','ğŸˆ¯','ğŸ’¹','â‡ï¸','âœ³ï¸','â','ğŸŒ','ğŸ’ ','â“‚ï¸','ğŸŒ€','ğŸ’¤','ğŸ§','ğŸš¾','â™¿','ğŸ…¿ï¸','ğŸ›—','ğŸˆ³','ğŸˆ‚ï¸','ğŸ›‚','ğŸ›ƒ','ğŸ›„','ğŸ›…','ğŸš¹','ğŸšº','ğŸš¼','âš§ï¸','ğŸš»','ğŸš®','ğŸ¦','ğŸ“¶','ğŸˆ','ğŸ”£','â„¹ï¸','ğŸ”¤','ğŸ”¡','ğŸ” ','ğŸ†–','ğŸ†—','ğŸ†™','ğŸ†’','ğŸ†•','ğŸ†“','0ï¸âƒ£','1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ğŸ”Ÿ','ğŸ”¢','#ï¸âƒ£','*ï¸âƒ£','âï¸','â–¶ï¸','â¸ï¸','â¯ï¸','â¹ï¸','âºï¸','â­ï¸','â®ï¸','â©','âª','â«','â¬','â—€ï¸','ğŸ”¼','ğŸ”½','â¡ï¸','â¬…ï¸','â¬†ï¸','â¬‡ï¸','â†—ï¸','â†˜ï¸','â†™ï¸','â†–ï¸','â†•ï¸','â†”ï¸','â†ªï¸','â†©ï¸','â¤´ï¸','â¤µï¸','ğŸ”€','ğŸ”','ğŸ”‚','ğŸ”„','ğŸ”ƒ','ğŸµ','ğŸ¶','â•','â–','â—','âœ–ï¸','ğŸŸ°','â™¾ï¸','ğŸ’²','ğŸ’±','â„¢ï¸','Â©ï¸','Â®ï¸','ğŸ‘ï¸â€ğŸ—¨ï¸','ğŸ”š','ğŸ”™','ğŸ”›','ğŸ”','ğŸ”œ','ã€°ï¸','â°','â¿','âœ”ï¸','â˜‘ï¸','ğŸ”˜','ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','âš«','âšª','ğŸŸ¤','ğŸ”º','ğŸ”»','ğŸ”¸','ğŸ”¹','ğŸ”¶','ğŸ”·','ğŸ”³','ğŸ”²','â–ªï¸','â–«ï¸','â—¾','â—½','â—¼ï¸','â—»ï¸','ğŸŸ¥','ğŸŸ§','ğŸŸ¨','ğŸŸ©','ğŸŸ¦','ğŸŸª','â¬›','â¬œ','ğŸŸ«','ğŸ”ˆ','ğŸ”‡','ğŸ”‰','ğŸ”Š','ğŸ””','ğŸ”•','ğŸ“£','ğŸ“¢','ğŸ’¬','ğŸ’­','ğŸ—¯ï¸','â™ ï¸','â™£ï¸','â™¥ï¸','â™¦ï¸','ğŸƒ','ğŸ´','ğŸ€„'] },
    { name: 'Flags', emojis: ['ğŸ','ğŸš©','ğŸŒ','ğŸ´','ğŸ³ï¸','ğŸ³ï¸â€ğŸŒˆ','ğŸ³ï¸â€âš§ï¸','ğŸ´â€â˜ ï¸','ğŸ‡ºğŸ‡¸','ğŸ‡¬ğŸ‡§','ğŸ‡«ğŸ‡·','ğŸ‡©ğŸ‡ª','ğŸ‡¯ğŸ‡µ','ğŸ‡°ğŸ‡·','ğŸ‡¨ğŸ‡³','ğŸ‡®ğŸ‡³','ğŸ‡§ğŸ‡·','ğŸ‡¨ğŸ‡¦','ğŸ‡¦ğŸ‡º','ğŸ‡²ğŸ‡½','ğŸ‡®ğŸ‡¹','ğŸ‡ªğŸ‡¸','ğŸ‡·ğŸ‡º','ğŸ‡¿ğŸ‡¦','ğŸ‡³ğŸ‡¬','ğŸ‡¦ğŸ‡·','ğŸ‡¨ğŸ‡´','ğŸ‡µğŸ‡ª','ğŸ‡¨ğŸ‡±','ğŸ‡»ğŸ‡ª','ğŸ‡ªğŸ‡¨','ğŸ‡§ğŸ‡´','ğŸ‡µğŸ‡¾','ğŸ‡ºğŸ‡¾','ğŸ‡¬ğŸ‡¾','ğŸ‡¸ğŸ‡·','ğŸ‡¹ğŸ‡·','ğŸ‡¸ğŸ‡¦','ğŸ‡¦ğŸ‡ª','ğŸ‡®ğŸ‡±','ğŸ‡ªğŸ‡¬','ğŸ‡°ğŸ‡ª','ğŸ‡¹ğŸ‡¿','ğŸ‡ªğŸ‡¹','ğŸ‡¬ğŸ‡­','ğŸ‡¨ğŸ‡®','ğŸ‡¸ğŸ‡³','ğŸ‡²ğŸ‡±','ğŸ‡¹ğŸ‡­','ğŸ‡»ğŸ‡³','ğŸ‡µğŸ‡­','ğŸ‡®ğŸ‡©','ğŸ‡²ğŸ‡¾','ğŸ‡¸ğŸ‡¬','ğŸ‡³ğŸ‡¿','ğŸ‡«ğŸ‡®','ğŸ‡¸ğŸ‡ª','ğŸ‡³ğŸ‡´','ğŸ‡©ğŸ‡°','ğŸ‡³ğŸ‡±','ğŸ‡§ğŸ‡ª','ğŸ‡¨ğŸ‡­','ğŸ‡¦ğŸ‡¹','ğŸ‡µğŸ‡±','ğŸ‡¨ğŸ‡¿','ğŸ‡­ğŸ‡º','ğŸ‡·ğŸ‡´','ğŸ‡¬ğŸ‡·','ğŸ‡µğŸ‡¹','ğŸ‡®ğŸ‡ª','ğŸ‡®ğŸ‡¸','ğŸ‡­ğŸ‡·','ğŸ‡ºğŸ‡¦','ğŸ‡¬ğŸ‡ª','ğŸ‡¦ğŸ‡²','ğŸ‡¦ğŸ‡¿','ğŸ‡°ğŸ‡¿','ğŸ‡ºğŸ‡¿','ğŸ‡µğŸ‡°','ğŸ‡§ğŸ‡©','ğŸ‡±ğŸ‡°','ğŸ‡³ğŸ‡µ','ğŸ‡²ğŸ‡²','ğŸ‡°ğŸ‡­','ğŸ‡±ğŸ‡¦','ğŸ‡²ğŸ‡³','ğŸ‡¹ğŸ‡¼','ğŸ‡­ğŸ‡°','ğŸ‡²ğŸ‡´','ğŸ‡¯ğŸ‡²','ğŸ‡¹ğŸ‡¹','ğŸ‡§ğŸ‡¸','ğŸ‡§ğŸ‡§','ğŸ‡­ğŸ‡¹','ğŸ‡©ğŸ‡´','ğŸ‡¨ğŸ‡º','ğŸ‡µğŸ‡·','ğŸ‡µğŸ‡¦','ğŸ‡¨ğŸ‡·','ğŸ‡¬ğŸ‡¹','ğŸ‡­ğŸ‡³','ğŸ‡¸ğŸ‡»','ğŸ‡³ğŸ‡®','ğŸ‡§ğŸ‡¿','ğŸ‡¶ğŸ‡¦','ğŸ‡°ğŸ‡¼','ğŸ‡§ğŸ‡­','ğŸ‡´ğŸ‡²','ğŸ‡¯ğŸ‡´','ğŸ‡±ğŸ‡§','ğŸ‡®ğŸ‡¶','ğŸ‡®ğŸ‡·','ğŸ‡¦ğŸ‡«','ğŸ‡±ğŸ‡¾','ğŸ‡¹ğŸ‡³','ğŸ‡©ğŸ‡¿','ğŸ‡²ğŸ‡¦'] },
  ];

  // Emoji search names (emoji â†’ space-separated keywords)
  const EN = {
    'ğŸ˜€':'grinning happy','ğŸ˜ƒ':'grinning big eyes happy','ğŸ˜„':'grinning squinting happy','ğŸ˜':'beaming grin','ğŸ˜†':'squinting laughing','ğŸ˜…':'sweat grinning nervous','ğŸ¤£':'rofl rolling floor laughing','ğŸ˜‚':'joy crying laughing tears','ğŸ™‚':'slightly smiling','ğŸ˜Š':'smiling blush','ğŸ˜‡':'angel innocent halo','ğŸ¥°':'smiling hearts love','ğŸ˜':'heart eyes love','ğŸ¤©':'star struck excited','ğŸ˜˜':'kiss blowing','ğŸ˜—':'kissing','ğŸ˜š':'kissing closed eyes','ğŸ˜™':'kissing smiling','ğŸ¥²':'smiling tear sad happy','ğŸ˜‹':'yummy delicious tongue','ğŸ˜›':'tongue out','ğŸ˜œ':'winking tongue','ğŸ¤ª':'zany crazy wild','ğŸ˜':'squinting tongue','ğŸ¤‘':'money face rich','ğŸ¤—':'hugging hug','ğŸ¤­':'hand over mouth giggle','ğŸ¤«':'shushing quiet secret','ğŸ¤”':'thinking hmm','ğŸ«¡':'salute','ğŸ¤':'zipper mouth shut','ğŸ¤¨':'raised eyebrow skeptical','ğŸ˜':'neutral face','ğŸ˜‘':'expressionless','ğŸ˜¶':'no mouth silent','ğŸ«¥':'dotted line invisible','ğŸ˜':'smirking smug','ğŸ˜’':'unamused','ğŸ™„':'eye roll','ğŸ˜¬':'grimacing awkward','ğŸ¤¥':'lying pinocchio','ğŸ˜Œ':'relieved','ğŸ˜”':'pensive sad','ğŸ˜ª':'sleepy tired','ğŸ¤¤':'drooling','ğŸ˜´':'sleeping zzz','ğŸ˜·':'mask sick','ğŸ¤’':'thermometer sick fever','ğŸ¤•':'bandage hurt injured','ğŸ¤¢':'nauseated green sick','ğŸ¤®':'vomiting sick throw up','ğŸ¥µ':'hot sweating','ğŸ¥¶':'cold freezing','ğŸ¥´':'woozy dizzy drunk','ğŸ˜µ':'dizzy knocked out','ğŸ¤¯':'exploding head mind blown','ğŸ¤ ':'cowboy hat','ğŸ¥³':'party celebration','ğŸ¥¸':'disguise glasses nose','ğŸ˜':'sunglasses cool','ğŸ¤“':'nerd glasses','ğŸ§':'monocle','ğŸ˜•':'confused','ğŸ«¤':'diagonal mouth','ğŸ˜Ÿ':'worried','ğŸ™':'frowning sad','ğŸ˜®':'open mouth surprised','ğŸ˜¯':'hushed','ğŸ˜²':'astonished shocked','ğŸ˜³':'flushed embarrassed','ğŸ¥º':'pleading puppy eyes','ğŸ¥¹':'holding back tears','ğŸ˜¦':'frowning open mouth','ğŸ˜§':'anguished','ğŸ˜¨':'fearful scared','ğŸ˜°':'anxious sweat','ğŸ˜¥':'sad relieved','ğŸ˜¢':'crying tear','ğŸ˜­':'loudly crying sobbing','ğŸ˜±':'screaming fear','ğŸ˜–':'confounded','ğŸ˜£':'persevering','ğŸ˜':'disappointed','ğŸ˜“':'downcast sweat','ğŸ˜©':'weary tired','ğŸ˜«':'tired exhausted','ğŸ¥±':'yawning boring','ğŸ˜¤':'huffing angry steam','ğŸ˜¡':'pouting angry red','ğŸ˜ ':'angry','ğŸ¤¬':'swearing cursing','ğŸ˜ˆ':'smiling devil','ğŸ‘¿':'angry devil','ğŸ’€':'skull dead','â˜ ï¸':'skull crossbones death','ğŸ’©':'poop poo','ğŸ¤¡':'clown','ğŸ‘¹':'ogre monster','ğŸ‘º':'goblin','ğŸ‘»':'ghost boo','ğŸ‘½':'alien','ğŸ‘¾':'space invader game','ğŸ¤–':'robot',
    'ğŸ‘‹':'wave waving hello hi bye','ğŸ¤š':'raised back hand','ğŸ–ï¸':'hand fingers splayed','âœ‹':'raised hand stop high five','ğŸ––':'vulcan spock','ğŸ«±':'rightward hand','ğŸ«²':'leftward hand','ğŸ«³':'palm down','ğŸ«´':'palm up','ğŸ‘Œ':'ok okay perfect','ğŸ¤Œ':'pinched fingers italian','ğŸ¤':'pinching small tiny','âœŒï¸':'peace victory','ğŸ¤':'crossed fingers luck','ğŸ«°':'hand with index and thumb crossed','ğŸ¤Ÿ':'love you sign','ğŸ¤˜':'rock on metal','ğŸ¤™':'call me shaka hang loose','ğŸ‘ˆ':'pointing left','ğŸ‘‰':'pointing right','ğŸ‘†':'pointing up','ğŸ–•':'middle finger','ğŸ‘‡':'pointing down','â˜ï¸':'index pointing up','ğŸ«µ':'pointing at viewer','ğŸ‘':'thumbs up like yes good','ğŸ‘':'thumbs down dislike no bad','âœŠ':'raised fist','ğŸ‘Š':'fist bump punch','ğŸ¤›':'left fist bump','ğŸ¤œ':'right fist bump','ğŸ‘':'clapping clap applause','ğŸ™Œ':'raising hands celebration','ğŸ«¶':'heart hands love','ğŸ‘':'open hands','ğŸ¤²':'palms up','ğŸ¤':'handshake deal','ğŸ™':'pray please thank you folded hands namaste','âœï¸':'writing','ğŸ’…':'nail polish','ğŸ¤³':'selfie','ğŸ’ª':'muscle strong bicep flex','ğŸ¦¾':'mechanical arm prosthetic','ğŸ¦¿':'mechanical leg prosthetic',
    'â¤ï¸':'red heart love','ğŸ§¡':'orange heart','ğŸ’›':'yellow heart','ğŸ’š':'green heart','ğŸ’™':'blue heart','ğŸ’œ':'purple heart','ğŸ–¤':'black heart','ğŸ¤':'white heart','ğŸ¤':'brown heart','ğŸ’”':'broken heart','â¤ï¸â€ğŸ”¥':'heart fire burning','â¤ï¸â€ğŸ©¹':'mending heart bandage','â£ï¸':'heart exclamation','ğŸ’•':'two hearts','ğŸ’':'revolving hearts','ğŸ’“':'beating heart','ğŸ’—':'growing heart','ğŸ’–':'sparkling heart','ğŸ’˜':'heart arrow cupid','ğŸ’':'heart ribbon gift','ğŸ’Ÿ':'heart decoration',
    'ğŸ¶':'dog puppy','ğŸ±':'cat kitty','ğŸ­':'mouse','ğŸ¹':'hamster','ğŸ°':'rabbit bunny','ğŸ¦Š':'fox','ğŸ»':'bear','ğŸ¼':'panda','ğŸ»â€â„ï¸':'polar bear','ğŸ¨':'koala','ğŸ¯':'tiger','ğŸ¦':'lion','ğŸ®':'cow','ğŸ·':'pig','ğŸ¸':'frog','ğŸµ':'monkey','ğŸ™ˆ':'see no evil monkey','ğŸ™‰':'hear no evil monkey','ğŸ™Š':'speak no evil monkey','ğŸ’':'monkey','ğŸ”':'chicken','ğŸ§':'penguin','ğŸ¦':'bird','ğŸ¤':'baby chick','ğŸ£':'hatching chick','ğŸ¥':'front facing chick','ğŸ¦†':'duck','ğŸ¦…':'eagle','ğŸ¦‰':'owl','ğŸ¦‡':'bat','ğŸº':'wolf','ğŸ—':'boar','ğŸ´':'horse','ğŸ¦„':'unicorn','ğŸ':'bee honeybee','ğŸ›':'bug caterpillar','ğŸ¦‹':'butterfly','ğŸŒ':'snail','ğŸ':'ladybug','ğŸœ':'ant','ğŸ¢':'turtle tortoise','ğŸ':'snake','ğŸ¦':'lizard','ğŸ¦–':'trex dinosaur','ğŸ¦•':'dinosaur sauropod','ğŸ™':'octopus','ğŸ¦‘':'squid','ğŸ¦':'shrimp','ğŸ¦':'lobster','ğŸ¦€':'crab','ğŸ¡':'blowfish','ğŸ ':'tropical fish','ğŸŸ':'fish','ğŸ¬':'dolphin','ğŸ³':'whale spouting','ğŸ‹':'whale','ğŸ¦ˆ':'shark','ğŸŠ':'crocodile','ğŸ…':'tiger','ğŸ†':'leopard','ğŸ¦“':'zebra','ğŸ¦':'gorilla','ğŸ¦§':'orangutan','ğŸ˜':'elephant','ğŸ¦›':'hippo','ğŸ¦':'rhino','ğŸª':'camel','ğŸ«':'two hump camel','ğŸ¦’':'giraffe','ğŸ¦˜':'kangaroo','ğŸƒ':'water buffalo','ğŸ‚':'ox','ğŸ„':'cow','ğŸ':'horse racing','ğŸ–':'pig','ğŸ':'ram','ğŸ‘':'sheep','ğŸ¦™':'llama','ğŸ':'goat','ğŸ¦Œ':'deer','ğŸ•':'dog','ğŸ©':'poodle','ğŸˆ':'cat','ğŸˆâ€â¬›':'black cat','ğŸ“':'rooster','ğŸ¦ƒ':'turkey','ğŸ¦š':'peacock','ğŸ¦œ':'parrot','ğŸ¦¢':'swan','ğŸ¦©':'flamingo','ğŸ•Šï¸':'dove peace','ğŸ‡':'rabbit','ğŸ¦':'raccoon','ğŸ¦¨':'skunk','ğŸ¦¡':'badger','ğŸ¦«':'beaver','ğŸ¦¦':'otter','ğŸ¦¥':'sloth','ğŸ':'mouse','ğŸ€':'rat','ğŸ¿ï¸':'chipmunk squirrel','ğŸ¦”':'hedgehog',
    'ğŸ':'red apple','ğŸ':'pear','ğŸŠ':'orange tangerine','ğŸ‹':'lemon','ğŸŒ':'banana','ğŸ‰':'watermelon','ğŸ‡':'grapes','ğŸ“':'strawberry','ğŸ«':'blueberries','ğŸˆ':'melon','ğŸ’':'cherries','ğŸ‘':'peach','ğŸ¥­':'mango','ğŸ':'pineapple','ğŸ¥¥':'coconut','ğŸ¥':'kiwi','ğŸ…':'tomato','ğŸ†':'eggplant aubergine','ğŸ¥‘':'avocado','ğŸ¥¦':'broccoli','ğŸ¥¬':'leafy green','ğŸ¥’':'cucumber','ğŸŒ¶ï¸':'hot pepper chili','ğŸ«‘':'bell pepper','ğŸŒ½':'corn','ğŸ¥•':'carrot','ğŸ§„':'garlic','ğŸ§…':'onion','ğŸ¥”':'potato','ğŸ ':'sweet potato','ğŸ¥':'croissant','ğŸ¥–':'baguette bread','ğŸ':'bread','ğŸ¥¨':'pretzel','ğŸ¥¯':'bagel','ğŸ§€':'cheese','ğŸ¥š':'egg','ğŸ³':'cooking fried egg','ğŸ¥':'pancakes','ğŸ§‡':'waffle','ğŸ¥“':'bacon','ğŸ¥©':'steak meat','ğŸ—':'poultry leg chicken','ğŸ–':'meat bone','ğŸŒ­':'hot dog','ğŸ”':'hamburger burger','ğŸŸ':'french fries','ğŸ•':'pizza','ğŸ¥ª':'sandwich','ğŸ¥™':'pita falafel','ğŸŒ®':'taco','ğŸŒ¯':'burrito','ğŸ¥—':'salad','ğŸ¥˜':'stew','ğŸ':'spaghetti pasta','ğŸœ':'noodles ramen','ğŸ²':'pot food','ğŸ›':'curry rice','ğŸ£':'sushi','ğŸ±':'bento box','ğŸ¤':'fried shrimp','ğŸ™':'rice ball','ğŸš':'rice','ğŸ˜':'rice cracker','ğŸ¥':'fish cake','ğŸ¢':'oden','ğŸ¡':'dango','ğŸ§':'shaved ice','ğŸ¨':'ice cream','ğŸ¦':'soft serve ice cream','ğŸ¥§':'pie','ğŸ§':'cupcake','ğŸ°':'cake shortcake','ğŸ‚':'birthday cake','ğŸ®':'custard pudding','ğŸ­':'lollipop candy','ğŸ¬':'candy sweet','ğŸ«':'chocolate bar','ğŸ¿':'popcorn','ğŸ©':'donut doughnut','ğŸª':'cookie','ğŸ¥œ':'peanuts','ğŸ¯':'honey pot','ğŸ¥›':'milk glass','ğŸ¼':'baby bottle','â˜•':'coffee hot','ğŸµ':'tea','ğŸ§ƒ':'juice box','ğŸ¥¤':'cup straw soda','ğŸ§‹':'boba bubble tea','ğŸ¶':'sake','ğŸº':'beer mug','ğŸ»':'clinking beers cheers','ğŸ¥‚':'champagne toast cheers','ğŸ·':'wine glass','ğŸ¥ƒ':'whiskey tumbler','ğŸ¸':'cocktail martini','ğŸ¹':'tropical drink','ğŸ¾':'champagne bottle celebrate',
    'âš½':'soccer football','ğŸ€':'basketball','ğŸˆ':'football american','âš¾':'baseball','ğŸ¾':'tennis','ğŸ':'volleyball','ğŸ‰':'rugby','ğŸ±':'pool billiards','ğŸ“':'ping pong table tennis','ğŸ¸':'badminton','ğŸ’':'ice hockey','ğŸ‘':'field hockey','ğŸ':'cricket','ğŸ¥…':'goal net','â›³':'golf flag','ğŸ¹':'bow arrow archery','ğŸ£':'fishing','ğŸ¥Š':'boxing glove','ğŸ¥‹':'martial arts','ğŸ›¹':'skateboard','ğŸ›·':'sled','â›¸ï¸':'ice skate','ğŸ¿':'ski','ğŸ‚':'snowboard','ğŸ„':'surfing surf','ğŸŠ':'swimming swim','ğŸ†':'trophy winner champion','ğŸ¥‡':'gold medal first place','ğŸ¥ˆ':'silver medal second','ğŸ¥‰':'bronze medal third','ğŸ…':'medal sports','ğŸª':'circus tent','ğŸ­':'theater drama performing arts','ğŸ¨':'art painting palette','ğŸ¬':'movie film clapper','ğŸ¤':'microphone karaoke singing','ğŸ§':'headphones music','ğŸ¼':'musical score','ğŸ¹':'piano keyboard','ğŸ¥':'drum','ğŸ·':'saxophone','ğŸº':'trumpet','ğŸ¸':'guitar','ğŸ»':'violin','ğŸ²':'dice game','ğŸ¯':'target bullseye dart','ğŸ³':'bowling','ğŸ®':'video game controller','ğŸ•¹ï¸':'joystick arcade','ğŸ§©':'puzzle jigsaw',
    'ğŸš—':'car automobile','ğŸš•':'taxi cab','ğŸš™':'suv','ğŸšŒ':'bus','ğŸï¸':'race car','ğŸš“':'police car','ğŸš‘':'ambulance','ğŸš’':'fire engine truck','ğŸš':'minibus','ğŸ›»':'pickup truck','ğŸšš':'delivery truck','ğŸš›':'semi truck','ğŸšœ':'tractor','ğŸï¸':'motorcycle','ğŸ›µ':'motor scooter','ğŸš²':'bicycle bike','ğŸ›´':'kick scooter','ğŸšƒ':'train railway','ğŸš…':'bullet train','ğŸš‡':'metro subway','âœˆï¸':'airplane plane','ğŸ›«':'takeoff departure','ğŸ›¬':'landing arrival','ğŸš€':'rocket','ğŸ›¸':'ufo flying saucer','ğŸš':'helicopter','â›µ':'sailboat','ğŸš¤':'speedboat','ğŸ›³ï¸':'cruise ship','ğŸš¢':'ship','ğŸ—¼':'tower','ğŸ°':'castle','ğŸŸï¸':'stadium','ğŸ¡':'ferris wheel','ğŸ¢':'roller coaster','ğŸ–ï¸':'beach umbrella','ğŸï¸':'island','ğŸŒ‹':'volcano','â›°ï¸':'mountain','ğŸ”ï¸':'snow mountain','ğŸ ':'house home','ğŸ¡':'garden house','ğŸ¢':'office building','ğŸ¥':'hospital','ğŸ«':'school','ğŸ›ï¸':'classical building','â›ª':'church','ğŸ•Œ':'mosque','ğŸ•':'synagogue','ğŸŒ…':'sunrise','ğŸŒ„':'sunrise mountains','ğŸŒ ':'shooting star','ğŸ†':'fireworks','ğŸ‡':'sparkler','ğŸŒ‡':'sunset city','ğŸŒƒ':'night stars','ğŸŒŒ':'milky way galaxy','ğŸŒ‰':'bridge night',
    'âŒš':'watch','ğŸ“±':'phone mobile','ğŸ’»':'laptop computer','âŒ¨ï¸':'keyboard','ğŸ–¥ï¸':'desktop computer monitor','ğŸ–¨ï¸':'printer','ğŸ’¾':'floppy disk save','ğŸ“·':'camera','ğŸ“¸':'camera flash','ğŸ“¹':'video camera','ğŸ¥':'movie camera','ğŸ“':'telephone','ğŸ“º':'television tv','ğŸ“»':'radio','â°':'alarm clock','âŒ›':'hourglass','ğŸ“¡':'satellite antenna','ğŸ”‹':'battery','ğŸ”Œ':'plug electric','ğŸ’¡':'light bulb idea','ğŸ”¦':'flashlight','ğŸ•¯ï¸':'candle','ğŸ’¸':'money wings flying','ğŸ’µ':'dollar bill','ğŸ’´':'yen bill','ğŸ’¶':'euro bill','ğŸ’·':'pound bill','ğŸ’°':'money bag','ğŸ’³':'credit card','ğŸ’':'gem diamond','ğŸ”§':'wrench','ğŸ”¨':'hammer','ğŸ› ï¸':'hammer wrench tools','ğŸ”©':'nut bolt','âš™ï¸':'gear settings','ğŸ”«':'water gun pistol','ğŸ’£':'bomb','ğŸ”ª':'knife','ğŸ—¡ï¸':'sword dagger','âš”ï¸':'crossed swords','ğŸ›¡ï¸':'shield','ğŸ”®':'crystal ball','ğŸ’ˆ':'barber pole','ğŸ”­':'telescope','ğŸ”¬':'microscope','ğŸ’Š':'pill medicine','ğŸ’‰':'syringe needle vaccine','ğŸ§¬':'dna','ğŸ§¹':'broom','ğŸš½':'toilet','ğŸš¿':'shower','ğŸ›':'bathtub bath','ğŸ§¼':'soap','ğŸ”‘':'key','ğŸ—ï¸':'old key','ğŸšª':'door','ğŸ›‹ï¸':'couch sofa','ğŸ›ï¸':'bed','ğŸ§¸':'teddy bear','ğŸ–¼ï¸':'picture frame','ğŸ›ï¸':'shopping bags','ğŸ›’':'shopping cart','ğŸ':'gift present wrapped','ğŸˆ':'balloon','ğŸ€':'ribbon bow','ğŸŠ':'confetti ball','ğŸ‰':'party popper tada celebration','ğŸ':'dolls','âœ‰ï¸':'envelope mail email','ğŸ“©':'envelope arrow incoming','ğŸ“§':'email e-mail','ğŸ’Œ':'love letter','ğŸ“¦':'package box','ğŸ“ª':'mailbox','ğŸ“œ':'scroll','ğŸ“„':'document page','ğŸ“Š':'chart bar graph','ğŸ“ˆ':'chart up trending','ğŸ“‰':'chart down trending','ğŸ“…':'calendar date','ğŸ—‘ï¸':'trash waste bin delete','ğŸ“‹':'clipboard','ğŸ“':'folder','ğŸ“‚':'open folder','ğŸ“°':'newspaper','ğŸ““':'notebook','ğŸ“•':'book red','ğŸ“—':'book green','ğŸ“˜':'book blue','ğŸ“š':'books stack','ğŸ”–':'bookmark','ğŸ”—':'link','ğŸ“':'paperclip','ğŸ“Œ':'pushpin pin','ğŸ“':'pin location','âœ‚ï¸':'scissors cut','ğŸ“':'memo note writing','âœï¸':'pencil','ğŸ”':'magnifying glass search','ğŸ”':'magnifying glass search right','ğŸ”’':'lock locked','ğŸ”“':'unlock unlocked',
    'â¤ï¸':'red heart love','â˜®ï¸':'peace','âœï¸':'cross christian','â˜ªï¸':'star crescent islam','â™ˆ':'aries zodiac','â™‰':'taurus zodiac','â™Š':'gemini zodiac','â™‹':'cancer zodiac','â™Œ':'leo zodiac','â™':'virgo zodiac','â™':'libra zodiac','â™':'scorpio zodiac','â™':'sagittarius zodiac','â™‘':'capricorn zodiac','â™’':'aquarius zodiac','â™“':'pisces zodiac','ğŸ†”':'id','â˜¢ï¸':'radioactive','â˜£ï¸':'biohazard','ğŸ†š':'versus vs','ğŸ’¯':'hundred perfect score','ğŸ’¢':'anger','â™¨ï¸':'hot springs','ğŸš«':'prohibited no forbidden','â—':'exclamation','â“':'question','â€¼ï¸':'double exclamation','â‰ï¸':'exclamation question','âš ï¸':'warning','â™»ï¸':'recycling recycle','âœ…':'check mark yes done','â':'cross mark no','âŒ':'cross mark no wrong','â­•':'circle','ğŸ”´':'red circle','ğŸŸ ':'orange circle','ğŸŸ¡':'yellow circle','ğŸŸ¢':'green circle','ğŸ”µ':'blue circle','ğŸŸ£':'purple circle','âš«':'black circle','âšª':'white circle','ğŸ”º':'red triangle up','ğŸ”»':'red triangle down','â–¶ï¸':'play','â¸ï¸':'pause','â¹ï¸':'stop','âºï¸':'record','â©':'fast forward','âª':'rewind','â¡ï¸':'right arrow','â¬…ï¸':'left arrow','â¬†ï¸':'up arrow','â¬‡ï¸':'down arrow','ğŸ”€':'shuffle','ğŸ”':'repeat loop','ğŸµ':'music note','ğŸ¶':'music notes','â•':'plus add','â–':'minus subtract','âœ–ï¸':'multiply','â—':'divide','â™¾ï¸':'infinity','ğŸ’²':'dollar sign','â„¢ï¸':'trademark','Â©ï¸':'copyright','Â®ï¸':'registered','âœ”ï¸':'check mark','ğŸ”˜':'radio button','ğŸ”ˆ':'speaker low','ğŸ”‡':'mute','ğŸ”‰':'speaker medium','ğŸ”Š':'speaker loud','ğŸ””':'bell notification','ğŸ”•':'bell slash mute','ğŸ’¬':'speech bubble chat','ğŸ’­':'thought bubble','â™ ï¸':'spade','â™£ï¸':'club','â™¥ï¸':'heart suit','â™¦ï¸':'diamond suit','ğŸƒ':'joker','ğŸ´':'flower playing card',
    'ğŸ':'checkered flag race','ğŸš©':'red flag','ğŸŒ':'crossed flags','ğŸ´':'black flag','ğŸ³ï¸':'white flag','ğŸ³ï¸â€ğŸŒˆ':'rainbow pride flag','ğŸ³ï¸â€âš§ï¸':'transgender flag','ğŸ´â€â˜ ï¸':'pirate flag','ğŸ‡ºğŸ‡¸':'usa america united states','ğŸ‡¬ğŸ‡§':'uk britain england','ğŸ‡«ğŸ‡·':'france','ğŸ‡©ğŸ‡ª':'germany','ğŸ‡¯ğŸ‡µ':'japan','ğŸ‡°ğŸ‡·':'korea south','ğŸ‡¨ğŸ‡³':'china','ğŸ‡®ğŸ‡³':'india','ğŸ‡§ğŸ‡·':'brazil','ğŸ‡¨ğŸ‡¦':'canada','ğŸ‡¦ğŸ‡º':'australia','ğŸ‡²ğŸ‡½':'mexico','ğŸ‡®ğŸ‡¹':'italy','ğŸ‡ªğŸ‡¸':'spain','ğŸ‡·ğŸ‡º':'russia','ğŸ‡¿ğŸ‡¦':'south africa','ğŸ‡³ğŸ‡¬':'nigeria','ğŸ‡¦ğŸ‡·':'argentina','ğŸ‡¨ğŸ‡´':'colombia','ğŸ‡µğŸ‡ª':'peru','ğŸ‡¨ğŸ‡±':'chile','ğŸ‡»ğŸ‡ª':'venezuela','ğŸ‡ªğŸ‡¨':'ecuador','ğŸ‡¹ğŸ‡·':'turkey','ğŸ‡¸ğŸ‡¦':'saudi arabia','ğŸ‡¦ğŸ‡ª':'uae emirates','ğŸ‡®ğŸ‡±':'israel','ğŸ‡ªğŸ‡¬':'egypt','ğŸ‡°ğŸ‡ª':'kenya','ğŸ‡¹ğŸ‡¿':'tanzania','ğŸ‡ªğŸ‡¹':'ethiopia','ğŸ‡¬ğŸ‡­':'ghana','ğŸ‡¹ğŸ‡­':'thailand','ğŸ‡»ğŸ‡³':'vietnam','ğŸ‡µğŸ‡­':'philippines','ğŸ‡®ğŸ‡©':'indonesia','ğŸ‡²ğŸ‡¾':'malaysia','ğŸ‡¸ğŸ‡¬':'singapore','ğŸ‡³ğŸ‡¿':'new zealand','ğŸ‡«ğŸ‡®':'finland','ğŸ‡¸ğŸ‡ª':'sweden','ğŸ‡³ğŸ‡´':'norway','ğŸ‡©ğŸ‡°':'denmark','ğŸ‡³ğŸ‡±':'netherlands','ğŸ‡§ğŸ‡ª':'belgium','ğŸ‡¨ğŸ‡­':'switzerland','ğŸ‡¦ğŸ‡¹':'austria','ğŸ‡µğŸ‡±':'poland','ğŸ‡¨ğŸ‡¿':'czech','ğŸ‡­ğŸ‡º':'hungary','ğŸ‡·ğŸ‡´':'romania','ğŸ‡¬ğŸ‡·':'greece','ğŸ‡µğŸ‡¹':'portugal','ğŸ‡®ğŸ‡ª':'ireland','ğŸ‡®ğŸ‡¸':'iceland','ğŸ‡ºğŸ‡¦':'ukraine','ğŸ‡µğŸ‡°':'pakistan','ğŸ‡§ğŸ‡©':'bangladesh','ğŸ‡±ğŸ‡°':'sri lanka','ğŸ‡³ğŸ‡µ':'nepal','ğŸ‡¹ğŸ‡¼':'taiwan','ğŸ‡­ğŸ‡°':'hong kong','ğŸ‡¯ğŸ‡²':'jamaica','ğŸ‡¨ğŸ‡º':'cuba','ğŸ‡µğŸ‡·':'puerto rico','ğŸ‡µğŸ‡¦':'panama','ğŸ‡¨ğŸ‡·':'costa rica','ğŸ‡®ğŸ‡¶':'iraq','ğŸ‡®ğŸ‡·':'iran','ğŸ‡¦ğŸ‡«':'afghanistan','ğŸ‡²ğŸ‡¦':'morocco',
  };

  // â”€â”€â”€ Avatar Colors â”€â”€â”€
  // Pleasant, muted palette that works on both dark and light backgrounds
  const AVATAR_COLORS = [
    '#5B8DEF', // blue
    '#43A692', // teal
    '#E8895C', // coral
    '#9B72CF', // purple
    '#D4644E', // terracotta
    '#5CAE6E', // green
    '#CB7EB5', // mauve
    '#6A9FD8', // sky
    '#C4965A', // amber
    '#7E8CC8', // periwinkle
  ];

  function avatarColor(name) {
    if (!name) return AVATAR_COLORS[0];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = ((hash << 5) - hash + name.charCodeAt(i)) | 0;
    }
    return AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length];
  }

  // Track whether the active conversation is a group chat
  let activeConvoIsGroup = false;

  // â”€â”€â”€ Utilities â”€â”€â”€
  function initials(name) {
    if (!name) return '?';
    return name.split(/\s+/).map(w => w[0]).slice(0, 2).join('').toUpperCase();
  }

  function formatTime(ms) {
    if (!ms) return '';
    const d = new Date(ms);
    const now = new Date();
    const diffDays = Math.floor((now - d) / 86400000);
    if (diffDays === 0) {
      return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    } else if (diffDays === 1) {
      return 'Yesterday';
    } else if (diffDays < 7) {
      return d.toLocaleDateString([], { weekday: 'short' });
    }
    return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
  }

  function formatMessageTime(ms) {
    if (!ms) return '';
    return new Date(ms).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
  }

  function isSameDay(ms1, ms2) {
    const a = new Date(ms1), b = new Date(ms2);
    return a.getFullYear() === b.getFullYear() &&
           a.getMonth() === b.getMonth() &&
           a.getDate() === b.getDate();
  }

  function formatDateDivider(ms) {
    const d = new Date(ms);
    const now = new Date();
    const diffDays = Math.floor((now - d) / 86400000);
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    return d.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
  }

  // â”€â”€â”€ Message Status Indicator â”€â”€â”€
  function formatStatusIndicator(status) {
    if (!status) return '';
    const s = status.toUpperCase();
    // Sending states
    if (s.includes('SENDING') || s.includes('YET_TO_SEND') || s.includes('RESENDING') ||
        s.includes('VALIDATING') || s.includes('SEND_AFTER_PROCESSING') ||
        s.includes('NOT_DELIVERED_YET')) {
      return '<span class="msg-status status-sending" title="Sending">\u23F3</span>';
    }
    // Read/displayed
    if (s.includes('DISPLAYED')) {
      return '<span class="msg-status status-read" title="Read">\u2713\u2713</span>';
    }
    // Delivered
    if (s.includes('DELIVERED')) {
      return '<span class="msg-status status-delivered" title="Delivered">\u2713\u2713</span>';
    }
    // Failed states
    if (s.includes('FAILED') || s.includes('CANCELED')) {
      return '<span class="msg-status status-failed" title="Failed">!</span>';
    }
    // Sent/complete (default for outgoing)
    if (s.includes('COMPLETE') || s.includes('OUTGOING')) {
      return '<span class="msg-status status-sent" title="Sent">\u2713</span>';
    }
    return '';
  }

  // â”€â”€â”€ API calls â”€â”€â”€
  async function fetchJSON(url) {
    const r = await fetch(API + url);
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  async function postJSON(url, body) {
    const r = await fetch(API + url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    return r.json();
  }

  // â”€â”€â”€ Render Conversations â”€â”€â”€
  function renderConversations(convos, isSearch) {
    if (!isSearch) conversations = convos;
    $convoList.innerHTML = '';
    if (!convos.length) {
      const emptyMsg = isSearch ? 'No results found' : 'No conversations yet';
      $convoList.innerHTML = `<div style="padding:40px 20px;text-align:center;color:var(--text-muted);font-size:13px">${emptyMsg}</div>`;
      return;
    }
    convos.forEach(c => {
      const el = document.createElement('div');
      const hasUnread = c.UnreadCount > 0;
      el.className = 'convo-item'
        + (c.ConversationID === activeConvoId ? ' active' : '')
        + (hasUnread ? ' unread' : '');
      el.dataset.id = c.ConversationID;
      const preview = c._searchPreview
        ? escapeHtml(c._searchPreview.substring(0, 60))
        : '&nbsp;';
      el.innerHTML = `
        <div class="convo-avatar" style="background:${avatarColor(c.Name)}">${initials(c.Name)}</div>
        <div class="convo-meta">
          <div class="convo-name">${escapeHtml(c.Name || 'Unknown')}</div>
          <div class="convo-preview">${preview}</div>
        </div>
        <div class="convo-time">${formatTime(c.LastMessageTS)}</div>
        ${hasUnread ? '<div class="convo-unread">' + c.UnreadCount + '</div>' : ''}
      `;
      el.addEventListener('click', () => selectConversation(c));
      $convoList.appendChild(el);
    });

    // Update page title with total unread count
    updateTitleUnreadCount(convos);
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function updateTitleUnreadCount(convos) {
    const total = convos.reduce((sum, c) => sum + (c.UnreadCount || 0), 0);
    document.title = total > 0 ? `(${total}) OpenMessage` : 'OpenMessage';
  }

  // â”€â”€â”€ Select Conversation â”€â”€â”€
  async function selectConversation(convo) {
    activeConvoId = convo.ConversationID;

    // Mark as read
    if (convo.UnreadCount > 0) {
      convo.UnreadCount = 0;
      fetch(API + '/api/mark-read', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ conversation_id: convo.ConversationID }),
      }).catch(() => {});
    }

    // Update sidebar active state
    document.querySelectorAll('.convo-item').forEach(el => {
      el.classList.toggle('active', el.dataset.id === activeConvoId);
      // Remove unread badge from the selected conversation
      if (el.dataset.id === activeConvoId) {
        el.classList.remove('unread');
        const badge = el.querySelector('.convo-unread');
        if (badge) badge.remove();
      }
    });

    // Show chat UI
    $emptyState.style.display = 'none';
    $chatHeader.style.display = 'flex';
    $messagesArea.style.display = 'flex';
    $composeBar.style.display = 'flex';

    $chatHeaderAvatar.textContent = initials(convo.Name);
    $chatHeaderAvatar.style.background = avatarColor(convo.Name);
    $chatHeaderName.textContent = convo.Name || 'Unknown';
    activeConvoIsGroup = !!convo.IsGroup;
    // Set default header status before loading messages
    if (convo.IsGroup) {
      $chatHeaderStatus.textContent = 'Group chat';
    } else {
      $chatHeaderStatus.textContent = '';
    }
    lastMsgCount = -1; // Force re-render on conversation switch
    await loadMessages(convo.ConversationID);

    // Start polling for new messages
    clearInterval(pollTimer);
    pollTimer = setInterval(() => loadMessages(activeConvoId), 3000);
  }

  // â”€â”€â”€ Load Messages â”€â”€â”€
  let lastMsgCount = 0;

  async function loadMessages(convoId) {
    try {
      const msgs = await fetchJSON(`/api/conversations/${convoId}/messages?limit=200`);
      // Reverse: API returns DESC, we want oldest first
      msgs.reverse();

      if (msgs.length === lastMsgCount && convoId === activeConvoId) return;
      lastMsgCount = msgs.length;

      const wasAtBottom = $messagesArea.scrollHeight - $messagesArea.scrollTop - $messagesArea.clientHeight < 60;

      $messagesArea.innerHTML = '';
      let lastDate = 0;
      let lastSenderName = null; // Track consecutive messages from same sender

      msgs.forEach((m, mi) => {
        // Date divider
        if (!isSameDay(m.TimestampMS, lastDate)) {
          const divider = document.createElement('div');
          divider.className = 'date-divider';
          divider.textContent = formatDateDivider(m.TimestampMS);
          $messagesArea.appendChild(divider);
          lastDate = m.TimestampMS;
        }

        // System/tombstone messages (protocol switches, chat creation)
        if ((m.Status || '').startsWith('TOMBSTONE_')) {
          const sysEl = document.createElement('div');
          sysEl.className = 'system-msg';
          let sysText = m.Body || '';
          if (m.Status.includes('RCS')) {
            sysText = 'ğŸ”’ ' + sysText;
          } else if (m.Status.includes('TEXT') || m.Status.includes('SMS')) {
            sysText = 'ğŸ’¬ ' + sysText;
          }
          sysEl.textContent = sysText;
          $messagesArea.appendChild(sysEl);
          return;
        }

        const el = document.createElement('div');
        el.className = 'msg ' + (m.IsFromMe ? 'sent' : 'received');

        let html = '';

        // Reply banner
        if (m.ReplyToID) {
          const original = msgs.find(om => om.MessageID === m.ReplyToID);
          const origName = original ? (original.SenderName || 'You') : '';
          const origBody = original ? (original.Body || 'Media') : 'Original message';
          const truncBody = origBody.length > 60 ? origBody.substring(0, 60) + '\u2026' : origBody;
          html += `<div class="msg-reply-preview" data-reply-id="${escapeHtml(m.ReplyToID)}" onclick="scrollToMessage('${escapeHtml(m.ReplyToID)}')"><span class="reply-author">${escapeHtml(origName)}</span><span class="reply-body">${escapeHtml(truncBody)}</span></div>`;
        }

        if (!m.IsFromMe && m.SenderName) {
          html += `<div class="msg-sender" style="color:${avatarColor(m.SenderName)}">${escapeHtml(m.SenderName)}</div>`;
        }
        if (m.MediaID || m.MimeType) {
          const mimeType = (m.MimeType || '').toLowerCase();
          const isImage = mimeType.startsWith('image/');
          const isVideo = mimeType.startsWith('video/');
          const hasMediaID = !!m.MediaID;
          const mediaSrc = `/api/media/${encodeURIComponent(m.MessageID)}`;
          const safeId = CSS.escape(m.MessageID);

          if (hasMediaID && isImage) {
            html += `<div class="msg-media">`;
            html += `<div class="msg-media-loading" data-msg-id="${escapeHtml(m.MessageID)}"><div class="spinner"></div>Loading image...</div>`;
            html += `<img src="${mediaSrc}" alt="Image" style="display:none" onload="this.style.display='block';this.previousElementSibling.remove();" onerror="var ldr=this.previousElementSibling;if(ldr){ldr.innerHTML='Image not available';}" onclick="showFullscreen(this.src,'image')">`;
            html += `</div>`;
          } else if (hasMediaID && isVideo) {
            html += `<div class="msg-media">`;
            html += `<div class="msg-media-loading" data-msg-id="${escapeHtml(m.MessageID)}"><div class="spinner"></div>Loading video...</div>`;
            html += `<video src="${mediaSrc}" preload="metadata" controls playsinline style="display:none" onloadeddata="this.style.display='block';this.previousElementSibling.remove();" onerror="var ldr=this.previousElementSibling;if(ldr){ldr.innerHTML='Video not available';}" onclick="event.stopPropagation()"></video>`;
            html += `</div>`;
          } else if (!hasMediaID && (isImage || isVideo)) {
            const icon = isImage ? '\uD83D\uDDBC\uFE0F' : '\uD83C\uDFA5';
            html += `<div style="padding:12px;background:var(--bg-tertiary, #f0f0f0);border-radius:8px;text-align:center;color:var(--text-muted, #999);font-size:13px">${icon} ${isImage ? 'Image' : 'Video'} from phone</div>`;
          } else if (hasMediaID) {
            html += `<div style="font-size:13px;color:var(--text-secondary);padding:6px 0">Attachment: ${escapeHtml(m.MimeType || 'file')}</div>`;
          } else {
            html += `<div style="font-size:13px;color:var(--text-muted);padding:6px 0">Attachment (${escapeHtml(m.MimeType || 'file')})</div>`;
          }
        }
        if (m.Body) {
          html += `<div class="msg-body">${escapeHtml(m.Body).replace(/\n/g, '<br>')}</div>`;
        }
        if (!m.Body && !m.MediaID) {
          html += `<div class="msg-body" style="color:var(--text-muted);font-style:italic">Empty message</div>`;
        }

        // Reactions
        if (m.Reactions) {
          try {
            const reactions = JSON.parse(m.Reactions);
            if (reactions.length > 0) {
              html += '<div class="msg-reactions">';
              reactions.forEach(r => {
                html += `<span class="reaction-pill" title="${r.count} reaction${r.count > 1 ? 's' : ''}">${r.emoji}<span class="reaction-count">${r.count > 1 ? r.count : ''}</span></span>`;
              });
              html += '</div>';
            }
          } catch(e) {}
        }

        html += `<div class="msg-time">${formatMessageTime(m.TimestampMS)}${m.IsFromMe ? formatStatusIndicator(m.Status) : ''}</div>`;

        // Hover action bar (Google Messages style)
        html += `<div class="msg-actions">`;
        html += `<button class="action-react" title="React"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></button>`;
        html += `<button class="action-reply" title="Reply"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg></button>`;
        html += `</div>`;

        // Emoji picker (hidden, toggled by react button)
        html += `<div class="emoji-picker" id="emoji-${m.MessageID}">`;
        QUICK_EMOJIS.forEach(e => {
          html += `<button onclick="sendReaction('${m.MessageID}','${e}')">${e}</button>`;
        });
        html += `<button class="emoji-plus" data-msg-id="${m.MessageID}" onclick="toggleFullEmojiPanel(event, '${m.MessageID}')">+</button>`;
        html += '</div>';

        // Full emoji panel (hidden, toggled by "+" button)
        html += `<div class="emoji-full-panel" id="emoji-full-${m.MessageID}">`;
        html += `<div class="emoji-search"><input type="text" placeholder="Search emoji..." oninput="filterEmojis(event, '${m.MessageID}')"></div>`;
        html += `<div class="emoji-grid" id="emoji-grid-${m.MessageID}">`;
        EMOJI_CATEGORIES.forEach(cat => {
          html += `<div class="emoji-cat-label">${cat.name}</div>`;
          cat.emojis.forEach(e => {
            html += `<button data-emoji="${e}" data-name="${EN[e]||''}" onclick="sendReactionFromGrid(this, '${m.MessageID}')">${e}</button>`;
          });
        });
        html += '</div></div>';

        el.innerHTML = html;
        el.dataset.msgId = m.MessageID;

        // Action bar: React button â†’ toggle emoji picker
        el.querySelector('.action-react').addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('.emoji-picker.show').forEach(p => p.classList.remove('show'));
          const picker = document.getElementById('emoji-' + m.MessageID);
          if (picker) picker.classList.toggle('show');
        });

        // Action bar: Reply button
        el.querySelector('.action-reply').addEventListener('click', (e) => {
          e.stopPropagation();
          setReplyTo(m);
        });

        // In group chats, wrap received messages with an avatar
        if (activeConvoIsGroup && !m.IsFromMe && m.SenderName) {
          // Show avatar only for the last message in a consecutive run from the same sender
          const nextMsg = msgs[mi + 1];
          const isLastFromSender = !nextMsg || nextMsg.IsFromMe || nextMsg.SenderName !== m.SenderName ||
            (nextMsg.Status || '').startsWith('TOMBSTONE_') || !isSameDay(m.TimestampMS, nextMsg.TimestampMS);

          const row = document.createElement('div');
          row.className = 'msg-row received';
          const avatarDiv = document.createElement('div');
          avatarDiv.className = 'msg-avatar' + (isLastFromSender ? '' : ' avatar-hidden');
          avatarDiv.style.background = avatarColor(m.SenderName);
          avatarDiv.textContent = initials(m.SenderName).charAt(0);
          row.appendChild(avatarDiv);
          row.appendChild(el);
          $messagesArea.appendChild(row);
        } else {
          $messagesArea.appendChild(el);
        }
        lastSenderName = m.IsFromMe ? null : m.SenderName;
      });

      // Update protocol indicator in header from most recent tombstone
      // msgs are in chronological order (oldest first), so findLast gets the latest
      const lastTombstone = msgs.findLast(m => (m.Status || '').startsWith('TOMBSTONE_'));
      if (lastTombstone) {
        if (lastTombstone.Status.includes('RCS')) {
          $chatHeaderStatus.innerHTML = '<span style="color:#4a9;">ğŸ”’ RCS</span>';
        } else if (lastTombstone.Status.includes('TEXT') || lastTombstone.Status.includes('SMS')) {
          $chatHeaderStatus.innerHTML = '<span style="color:var(--text-muted)">SMS</span>';
        }
      }

      if (wasAtBottom || msgs.length !== lastMsgCount) {
        $messagesArea.scrollTop = $messagesArea.scrollHeight;
      }
    } catch (err) {
      console.error('Failed to load messages:', err);
    }
  }

  // â”€â”€â”€ Send Message â”€â”€â”€
  async function sendMessage() {
    const text = $composeInput.value.trim();
    const hasMedia = !!pendingFile;
    if ((!text && !hasMedia) || !activeConvoId) return;

    $composeInput.value = '';
    $sendBtn.disabled = true;
    autoResize();

    // Optimistic UI: show message immediately before server round-trip
    if (text && !hasMedia) {
      const el = document.createElement('div');
      el.className = 'msg sent';
      el.innerHTML = `<div class="msg-body">${escapeHtml(text)}</div><div class="msg-time">${formatMessageTime(Date.now())} <span style="opacity:0.5">&#10003;</span></div>`;
      $messagesArea.appendChild(el);
      $messagesArea.scrollTop = $messagesArea.scrollHeight;
    }

    try {
      if (hasMedia) {
        // Send media via multipart form
        const form = new FormData();
        form.append('conversation_id', activeConvoId);
        form.append('file', pendingFile.file);
        const resp = await fetch('/api/send-media', { method: 'POST', body: form });
        if (!resp.ok) throw new Error(await resp.text());
        clearAttachment();
      }
      if (text) {
        const payload = {
          conversation_id: activeConvoId,
          message: text,
        };
        if (replyToMsg) {
          payload.reply_to_id = replyToMsg.MessageID;
        }
        await postJSON('/api/send', payload);
      }
      clearReply();
      // Refresh to get the real message from server
      lastMsgCount = -1;
      await loadMessages(activeConvoId);
      await loadConversations();
    } catch (err) {
      console.error('Failed to send:', err);
    }
  }

  // â”€â”€â”€ Compose Input â”€â”€â”€
  function autoResize() {
    $composeInput.style.height = 'auto';
    $composeInput.style.height = Math.min($composeInput.scrollHeight, 160) + 'px';
    $sendBtn.disabled = !$composeInput.value.trim();
  }

  $composeInput.addEventListener('input', autoResize);
  $composeInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  $sendBtn.addEventListener('click', sendMessage);

  // â”€â”€â”€ Attachments (paste + file picker) â”€â”€â”€
  function setAttachment(file) {
    pendingFile = { file };
    $attachName.textContent = file.name || 'Pasted image';
    $attachPreview.classList.add('active');
    $sendBtn.disabled = false;

    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = e => { $attachThumb.src = e.target.result; $attachThumb.style.display = 'block'; };
      reader.readAsDataURL(file);
    } else {
      $attachThumb.style.display = 'none';
    }
  }

  function clearAttachment() {
    pendingFile = null;
    $attachPreview.classList.remove('active');
    $attachThumb.src = '';
    $attachName.textContent = '';
    $fileInput.value = '';
    autoResize();
  }

  // Paste handler: Ctrl+V / Cmd+V with image data
  $composeInput.addEventListener('paste', e => {
    const items = e.clipboardData?.items;
    if (!items) return;
    for (const item of items) {
      if (item.kind === 'file' && item.type.startsWith('image/')) {
        e.preventDefault();
        const file = item.getAsFile();
        if (file) setAttachment(file);
        return;
      }
    }
  });

  // File picker button
  $attachBtn.addEventListener('click', () => $fileInput.click());
  $fileInput.addEventListener('change', () => {
    if ($fileInput.files[0]) setAttachment($fileInput.files[0]);
  });
  $attachRemove.addEventListener('click', clearAttachment);

  // â”€â”€â”€ Search â”€â”€â”€
  let searchTimeout;
  $searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    const q = $searchInput.value.trim();
    if (!q) {
      loadConversations();
      return;
    }
    searchTimeout = setTimeout(async () => {
      try {
        const results = await fetchJSON(`/api/search?q=${encodeURIComponent(q)}&limit=30`);
        // Group search results by conversation, resolve names from conversations list
        const convoMap = {};
        conversations.forEach(c => { convoMap[c.ConversationID] = c; });
        const byConvo = {};
        results.forEach(m => {
          if (!byConvo[m.ConversationID]) {
            const convo = convoMap[m.ConversationID];
            byConvo[m.ConversationID] = {
              id: m.ConversationID,
              name: convo ? convo.Name : (m.SenderName || 'Unknown'),
              body: m.Body,
              ts: m.TimestampMS,
              isGroup: convo ? convo.IsGroup : false,
            };
          }
        });
        const searchConvos = Object.values(byConvo).map(c => ({
          ConversationID: c.id,
          Name: c.name || 'Unknown',
          LastMessageTS: c.ts,
          IsGroup: c.isGroup,
          _searchPreview: c.body,
        }));
        renderConversations(searchConvos, true);
      } catch (err) {
        console.error('Search failed:', err);
      }
    }, 300);
  });

  // â”€â”€â”€ Status Check â”€â”€â”€
  async function checkStatus() {
    try {
      const status = await fetchJSON('/api/status');
      if (status.connected) {
        $connectionBanner.className = 'connection-banner';
      } else {
        $connectionBanner.className = 'connection-banner disconnected';
      }
    } catch {
      $connectionBanner.className = 'connection-banner disconnected';
    }
  }

  // â”€â”€â”€ Load Conversations â”€â”€â”€
  async function loadConversations() {
    try {
      const convos = await fetchJSON('/api/conversations?limit=50');
      renderConversations(convos);
    } catch (err) {
      console.error('Failed to load conversations:', err);
    }
  }

  // â”€â”€â”€ Reactions â”€â”€â”€
  window.sendReaction = async function(messageId, emoji) {
    // Close pickers
    document.querySelectorAll('.emoji-picker.show').forEach(p => p.classList.remove('show'));
    document.querySelectorAll('.emoji-full-panel.show').forEach(p => p.classList.remove('show'));
    try {
      await postJSON('/api/react', {
        message_id: messageId,
        emoji: emoji,
        conversation_id: activeConvoId,
        action: 'add',
      });
      // Reload to see updated reactions
      if (activeConvoId) await loadMessages(activeConvoId);
    } catch (err) {
      console.error('Failed to send reaction:', err);
    }
  };

  // Toggle full emoji panel from "+" button
  window.toggleFullEmojiPanel = function(event, messageId) {
    event.stopPropagation();
    // Close the quick picker
    document.querySelectorAll('.emoji-picker.show').forEach(p => p.classList.remove('show'));
    // Toggle the full panel
    const panel = document.getElementById('emoji-full-' + messageId);
    if (panel) {
      // Close any other open panels first
      document.querySelectorAll('.emoji-full-panel.show').forEach(p => {
        if (p !== panel) p.classList.remove('show');
      });
      panel.classList.toggle('show');
      if (panel.classList.contains('show')) {
        const input = panel.querySelector('input');
        if (input) { input.value = ''; input.focus(); }
        // Reset grid to show all emojis
        panel.querySelectorAll('.emoji-grid button, .emoji-grid .emoji-cat-label').forEach(el => {
          el.style.display = '';
        });
      }
    }
  };

  // Filter emojis in full panel by search term
  window.filterEmojis = function(event, messageId) {
    const query = event.target.value.toLowerCase().trim();
    const grid = document.getElementById('emoji-grid-' + messageId);
    if (!grid) return;
    grid.querySelectorAll('button').forEach(btn => {
      if (!query) {
        btn.style.display = '';
      } else {
        const name = (btn.dataset.name || '').toLowerCase();
        const match = name.split(/\s+/).some(word => word.startsWith(query)) || name.includes(query);
        btn.style.display = match ? '' : 'none';
      }
    });
    // Hide category labels if all their emojis are hidden
    grid.querySelectorAll('.emoji-cat-label').forEach(label => {
      let next = label.nextElementSibling;
      let anyVisible = false;
      while (next && !next.classList.contains('emoji-cat-label')) {
        if (next.style.display !== 'none') anyVisible = true;
        next = next.nextElementSibling;
      }
      label.style.display = anyVisible ? '' : 'none';
    });
  };

  // Send reaction from full grid (reads emoji from button text)
  window.sendReactionFromGrid = function(btn, messageId) {
    const emoji = btn.textContent.trim();
    sendReaction(messageId, emoji);
    // Close the full panel
    document.querySelectorAll('.emoji-full-panel.show').forEach(p => p.classList.remove('show'));
  };

  // Close react picker and full panel when clicking elsewhere
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.emoji-picker') && !e.target.closest('.emoji-full-panel') && !e.target.closest('.msg-actions')) {
      document.querySelectorAll('.emoji-picker.show').forEach(p => p.classList.remove('show'));
      document.querySelectorAll('.emoji-full-panel.show').forEach(p => p.classList.remove('show'));
    }
  });

  // â”€â”€â”€ Reply â”€â”€â”€
  function setReplyTo(msg) {
    replyToMsg = msg;
    $replyToName.textContent = msg.SenderName || 'You';
    $replyToText.textContent = (msg.Body || 'Media').substring(0, 80);
    $replyIndicator.classList.add('show');
    $composeInput.focus();
  }

  function clearReply() {
    replyToMsg = null;
    $replyIndicator.classList.remove('show');
  }

  $replyClose.addEventListener('click', clearReply);

  window.scrollToMessage = function(msgId) {
    const el = document.querySelector(`[data-msg-id="${msgId}"]`);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      el.style.outline = '2px solid var(--accent)';
      setTimeout(() => { el.style.outline = ''; }, 1500);
    }
  };

  // â”€â”€â”€ Fullscreen Media Viewer â”€â”€â”€
  window.showFullscreen = function(src, type) {
    const overlay = document.createElement('div');
    overlay.className = 'msg-image-fullscreen';

    if (type === 'video') {
      overlay.innerHTML = `<video src="${src}" controls autoplay playsinline></video><button class="fullscreen-close">&times;</button>`;
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay || e.target.classList.contains('fullscreen-close')) {
          const vid = overlay.querySelector('video');
          if (vid) vid.pause();
          overlay.remove();
        }
      });
    } else {
      overlay.innerHTML = `<img src="${src}" alt="Full size"><button class="fullscreen-close">&times;</button>`;
      overlay.addEventListener('click', () => overlay.remove());
    }

    document.body.appendChild(overlay);
  };

  // â”€â”€â”€ Keyboard Shortcuts â”€â”€â”€
  // Helper: get ordered list of conversation items in the sidebar
  function getConvoItems() {
    return Array.from($convoList.querySelectorAll('.convo-item'));
  }

  // Helper: index of currently active conversation in sidebar list
  function getActiveConvoIndex() {
    const items = getConvoItems();
    return items.findIndex(el => el.classList.contains('active'));
  }

  // Helper: select conversation at a given index in the sidebar list
  function selectConvoByIndex(idx) {
    const items = getConvoItems();
    if (items.length === 0) return;
    const clamped = Math.max(0, Math.min(idx, items.length - 1));
    items[clamped].click();
    items[clamped].scrollIntoView({ block: 'nearest' });
  }

  // Helper: deselect current conversation and return to empty state
  function deselectConversation() {
    activeConvoId = null;
    activeConvoIsGroup = false;
    clearInterval(pollTimer);
    document.querySelectorAll('.convo-item').forEach(el => el.classList.remove('active'));
    $emptyState.style.display = '';
    $chatHeader.style.display = 'none';
    $messagesArea.style.display = 'none';
    $composeBar.style.display = 'none';
    $messagesArea.innerHTML = '';
    clearReply();
  }

  document.addEventListener('keydown', function(e) {
    const tag = (e.target.tagName || '').toLowerCase();
    const isInput = (tag === 'input' || tag === 'textarea' || e.target.isContentEditable);
    const mod = e.metaKey || e.ctrlKey;

    // â”€â”€ Cmd/Ctrl+K: Focus search (works everywhere) â”€â”€
    if (mod && e.key === 'k') {
      e.preventDefault();
      $searchInput.focus();
      $searchInput.select();
      return;
    }

    // â”€â”€ Escape: works everywhere â”€â”€
    if (e.key === 'Escape') {
      e.preventDefault();
      // Close fullscreen image viewer if open
      const fullscreen = document.querySelector('.msg-image-fullscreen');
      if (fullscreen) { fullscreen.remove(); return; }
      // Close any open emoji pickers or full panels
      const openPanels = document.querySelectorAll('.emoji-full-panel.show');
      if (openPanels.length) { openPanels.forEach(p => p.classList.remove('show')); return; }
      const openPickers = document.querySelectorAll('.emoji-picker.show');
      if (openPickers.length) { openPickers.forEach(p => p.classList.remove('show')); return; }
      // Clear search if there is text
      if ($searchInput.value.trim()) {
        $searchInput.value = '';
        loadConversations();
        $searchInput.blur();
        return;
      }
      // Clear reply indicator if showing
      if (replyToMsg) { clearReply(); return; }
      // Deselect conversation
      if (activeConvoId) { deselectConversation(); return; }
      // Blur any focused input
      if (document.activeElement) document.activeElement.blur();
      return;
    }

    // â”€â”€ Cmd/Ctrl+N: New message / focus compose (works everywhere) â”€â”€
    if (mod && e.key === 'n') {
      e.preventDefault();
      if (activeConvoId) {
        $composeInput.focus();
      } else {
        // No conversation selected â€” focus search so user can find/start one
        $searchInput.focus();
        $searchInput.select();
      }
      return;
    }

    // â”€â”€ Cmd/Ctrl+Shift+] : Next conversation (works everywhere) â”€â”€
    if (mod && e.shiftKey && e.key === ']') {
      e.preventDefault();
      const idx = getActiveConvoIndex();
      selectConvoByIndex(idx + 1);
      return;
    }

    // â”€â”€ Cmd/Ctrl+Shift+[ : Previous conversation (works everywhere) â”€â”€
    if (mod && e.shiftKey && e.key === '[') {
      e.preventDefault();
      const idx = getActiveConvoIndex();
      selectConvoByIndex(idx < 0 ? 0 : idx - 1);
      return;
    }

    // â”€â”€ The remaining shortcuts should NOT fire when typing in inputs â”€â”€
    if (isInput) return;

    // â”€â”€ Up/Down arrows: Navigate conversations in sidebar â”€â”€
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      const idx = getActiveConvoIndex();
      selectConvoByIndex(idx + 1);
      return;
    }

    if (e.key === 'ArrowUp') {
      e.preventDefault();
      const idx = getActiveConvoIndex();
      selectConvoByIndex(idx < 0 ? 0 : idx - 1);
      return;
    }
  });

  // â”€â”€â”€ New Message â”€â”€â”€
  function openNewMsg() {
    $newMsgOverlay.classList.add('show');
    $newMsgPhone.value = '';
    $newMsgError.style.display = 'none';
    $newMsgGo.disabled = false;
    $newMsgGo.textContent = 'Start conversation';
    setTimeout(() => $newMsgPhone.focus(), 100);
  }

  function closeNewMsg() {
    $newMsgOverlay.classList.remove('show');
  }

  async function startNewConversation() {
    const phone = $newMsgPhone.value.trim().replace(/[\s\-()]/g, '');
    if (!phone) return;
    $newMsgGo.disabled = true;
    $newMsgGo.textContent = 'Connecting...';
    $newMsgError.style.display = 'none';
    try {
      const resp = await fetch(API + '/api/new-conversation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone_number: phone }),
      });
      if (!resp.ok) {
        const errText = await resp.text();
        throw new Error(errText);
      }
      const data = await resp.json();
      closeNewMsg();
      // Refresh conversation list and select the new one
      await loadConversations();
      const convo = conversations.find(c => c.ConversationID === data.conversation_id);
      if (convo) {
        selectConversation(convo);
      } else {
        // Conversation might not be in the list yet, create a minimal one
        selectConversation({
          ConversationID: data.conversation_id,
          Name: data.name || phone,
        });
      }
    } catch (err) {
      $newMsgError.textContent = err.message || 'Failed to start conversation';
      $newMsgError.style.display = 'block';
      $newMsgGo.disabled = false;
      $newMsgGo.textContent = 'Start conversation';
    }
  }

  $newMsgBtn.addEventListener('click', openNewMsg);
  $newMsgClose.addEventListener('click', closeNewMsg);
  $newMsgGo.addEventListener('click', startNewConversation);
  $newMsgPhone.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      startNewConversation();
    }
    if (e.key === 'Escape') {
      e.preventDefault();
      closeNewMsg();
    }
  });

  // â”€â”€â”€ Init â”€â”€â”€
  loadConversations();
  checkStatus();
  setInterval(checkStatus, 10000);
  setInterval(() => {
    if (!$searchInput.value.trim()) loadConversations();
  }, 5000);
})();
</script>
</body>
</html>
