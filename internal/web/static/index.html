<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenMessages</title>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #111111;
  --bg-surface: #1a1a1a;
  --bg-elevated: #242424;
  --bg-hover: #2e2e2e;
  --text-primary: #faf6f1;
  --text-secondary: #a09890;
  --text-muted: #6b6560;
  --accent: #e8a44a;
  --accent-dim: rgba(232, 164, 74, 0.15);
  --accent-glow: rgba(232, 164, 74, 0.08);
  --cream: #faf6f1;
  --cream-soft: rgba(250, 246, 241, 0.06);
  --sent-bg: #2a2520;
  --received-bg: #1e1e1e;
  --border: rgba(250, 246, 241, 0.06);
  --border-accent: rgba(232, 164, 74, 0.25);
  --radius-sm: 4px;
  --radius-md: 12px;
  --radius-lg: 20px;
  --font-serif: 'Instrument Serif', Georgia, serif;
  --font-sans: 'DM Sans', -apple-system, sans-serif;
  --shadow-soft: 0 2px 20px rgba(0,0,0,0.3);
  --shadow-glow: 0 0 40px rgba(232, 164, 74, 0.06);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  height: 100%;
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 15px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  overflow: hidden;
}

/* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
.app {
  display: grid;
  grid-template-columns: 340px 1fr;
  height: 100vh;
}

/* ‚îÄ‚îÄ‚îÄ Left Rail: Conversation List ‚îÄ‚îÄ‚îÄ */
.sidebar {
  background: var(--bg-surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}

.sidebar-header h1 {
  font-family: var(--font-serif);
  font-size: 28px;
  font-weight: 400;
  letter-spacing: -0.5px;
  color: var(--text-primary);
}

.sidebar-header h1 span {
  color: var(--accent);
}

.search-box {
  margin: 16px 20px 12px;
  position: relative;
}

.search-box input {
  width: 100%;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 10px 16px 10px 40px;
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.search-box input::placeholder { color: var(--text-muted); }

.search-box input:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}

.search-box svg {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  width: 16px;
  height: 16px;
}

.conversation-list {
  flex: 1;
  overflow-y: auto;
  padding: 4px 8px;
}

.conversation-list::-webkit-scrollbar { width: 4px; }
.conversation-list::-webkit-scrollbar-track { background: transparent; }
.conversation-list::-webkit-scrollbar-thumb {
  background: var(--text-muted);
  border-radius: 2px;
}

.convo-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}

.convo-item:hover { background: var(--bg-hover); }

.convo-item.active {
  background: var(--accent-dim);
}

.convo-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 3px;
  height: 28px;
  background: var(--accent);
  border-radius: 0 2px 2px 0;
}

.convo-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-sans);
  font-size: 17px;
  font-weight: 600;
  color: #ffffff;
  flex-shrink: 0;
  border: none;
  letter-spacing: 0.5px;
}

.convo-item.active .convo-avatar {
  box-shadow: 0 0 0 2px var(--bg-surface), 0 0 0 4px var(--border-accent);
}

.convo-meta {
  flex: 1;
  min-width: 0;
}

.convo-name {
  font-family: var(--font-serif);
  font-size: 16px;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.convo-preview {
  font-size: 13px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 2px;
}

.convo-time {
  font-size: 11px;
  color: var(--text-muted);
  flex-shrink: 0;
  align-self: flex-start;
  margin-top: 2px;
}

.convo-unread {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  border-radius: 10px;
  background: var(--accent);
  color: var(--bg-deep);
  font-size: 11px;
  font-weight: 700;
  font-family: var(--font-sans);
  flex-shrink: 0;
  align-self: center;
}

.convo-item.unread .convo-name {
  font-weight: 600;
  color: var(--cream);
}

.convo-item.unread .convo-preview {
  color: var(--text-primary);
  font-weight: 500;
}

/* ‚îÄ‚îÄ‚îÄ Right Pane: Messages ‚îÄ‚îÄ‚îÄ */
.chat-pane {
  display: flex;
  flex-direction: column;
  background: var(--bg-deep);
  overflow: hidden;
}

.chat-header {
  padding: 20px 28px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  display: flex;
  align-items: center;
  gap: 14px;
}

.chat-header-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-sans);
  font-size: 15px;
  font-weight: 600;
  color: #ffffff;
  flex-shrink: 0;
  border: none;
}

.chat-header-name {
  font-family: var(--font-serif);
  font-size: 20px;
  font-weight: 400;
}

.chat-header-status {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 1px;
}

.messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 24px 28px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.messages-area::-webkit-scrollbar { width: 4px; }
.messages-area::-webkit-scrollbar-track { background: transparent; }
.messages-area::-webkit-scrollbar-thumb {
  background: rgba(250, 246, 241, 0.1);
  border-radius: 2px;
}

.msg {
  max-width: 520px;
  padding: 10px 16px;
  border-radius: var(--radius-lg);
  font-size: 14.5px;
  line-height: 1.55;
  animation: msgIn 0.25s ease-out;
  position: relative;
  overflow: visible;
}

@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.sent {
  align-self: flex-end;
  background: var(--sent-bg);
  color: var(--cream);
  border-bottom-right-radius: var(--radius-sm);
  border: 1px solid rgba(232, 164, 74, 0.12);
}

.msg.received {
  align-self: flex-start;
  background: var(--received-bg);
  color: var(--text-primary);
  border-bottom-left-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

/* ‚îÄ‚îÄ‚îÄ Message Avatar (group chats) ‚îÄ‚îÄ‚îÄ */
.msg-row {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  max-width: 560px;
  animation: msgIn 0.25s ease-out;
}

.msg-row.sent {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.msg-row.received {
  align-self: flex-start;
}

.msg-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-sans);
  font-size: 11px;
  font-weight: 600;
  color: #ffffff;
  flex-shrink: 0;
  margin-bottom: 2px;
}

.msg-avatar.avatar-hidden {
  visibility: hidden;
}

.msg-row .msg {
  align-self: auto;
  animation: none;
  min-width: 0;
}

.msg-sender {
  font-size: 12px;
  font-weight: 500;
  color: var(--accent);
  margin-bottom: 3px;
  font-family: var(--font-sans);
}

.msg-time {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
  text-align: right;
}

.msg.sent .msg-time { color: rgba(250, 246, 241, 0.35); }

/* ‚îÄ‚îÄ‚îÄ Message Status Indicators ‚îÄ‚îÄ‚îÄ */
.msg-status {
  display: inline-block;
  margin-left: 4px;
  font-size: 11px;
  vertical-align: middle;
  line-height: 1;
}

.msg-status.status-sending {
  color: rgba(250, 246, 241, 0.35);
  font-size: 10px;
}

.msg-status.status-sent {
  color: rgba(250, 246, 241, 0.35);
}

.msg-status.status-delivered {
  color: rgba(250, 246, 241, 0.45);
}

.msg-status.status-read {
  color: var(--accent);
}

.msg-status.status-failed {
  color: #dc503c;
  font-size: 10px;
}

/* ‚îÄ‚îÄ‚îÄ Media (images & videos) ‚îÄ‚îÄ‚îÄ */
.msg-media {
  margin: 4px 0;
  position: relative;
  border-radius: var(--radius-md);
  overflow: hidden;
  max-width: 320px;
}

.msg.sent .msg-media { margin-left: auto; }

.msg-media img {
  max-width: 100%;
  max-height: 300px;
  border-radius: var(--radius-md);
  cursor: pointer;
  display: block;
  background: var(--bg-elevated);
  min-height: 60px;
  object-fit: cover;
}

.msg-media video {
  max-width: 100%;
  max-height: 300px;
  border-radius: var(--radius-md);
  display: block;
  background: #000;
  object-fit: cover;
}

/* Legacy class compat */
.msg-image {
  max-width: 320px;
  max-height: 400px;
  border-radius: var(--radius-md);
  margin: 4px 0;
  cursor: pointer;
  display: block;
  background: var(--bg-elevated);
  min-height: 80px;
  object-fit: contain;
}

.msg-image-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 200px;
  height: 120px;
  border-radius: var(--radius-md);
  background: var(--bg-elevated);
  color: var(--text-muted);
  font-size: 12px;
  margin: 4px 0;
}

.msg-media-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 200px;
  height: 120px;
  border-radius: var(--radius-md);
  background: var(--bg-elevated);
  color: var(--text-muted);
  font-size: 12px;
  margin: 4px 0;
}

.msg-media-loading .spinner {
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.msg.sent .msg-image { margin-left: auto; }

.msg-image-fullscreen {
  position: fixed;
  inset: 0;
  z-index: 100;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: zoom-out;
}

.msg-image-fullscreen img {
  max-width: 90vw;
  max-height: 90vh;
  object-fit: contain;
  border-radius: var(--radius-md);
}

.msg-image-fullscreen video {
  max-width: 90vw;
  max-height: 90vh;
  object-fit: contain;
  border-radius: var(--radius-md);
}

.msg-image-fullscreen .fullscreen-close {
  position: absolute;
  top: 20px;
  right: 24px;
  background: none;
  border: none;
  color: #fff;
  font-size: 32px;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.15s;
  line-height: 1;
}

.msg-image-fullscreen .fullscreen-close:hover {
  opacity: 1;
}

/* ‚îÄ‚îÄ‚îÄ Reactions ‚îÄ‚îÄ‚îÄ */
.msg-reactions {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  position: absolute;
  bottom: -12px;
  left: 12px;
  z-index: 2;
}

.msg.sent .msg-reactions {
  left: auto;
  right: 12px;
}

.msg:has(.msg-reactions) {
  margin-bottom: 18px;
}

.reaction-pill {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  padding: 1px 6px;
  border-radius: 10px;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  font-size: 14px;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  line-height: 1.4;
}

.reaction-pill:hover {
  background: var(--accent-dim);
  border-color: var(--border-accent);
}

.reaction-pill .reaction-count {
  font-size: 10px;
  color: var(--text-muted);
}

/* ‚îÄ‚îÄ‚îÄ Message Hover Action Bar (Google Messages style) ‚îÄ‚îÄ‚îÄ */
.msg-actions {
  position: absolute;
  top: -16px;
  display: none;
  align-items: center;
  gap: 2px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 2px 4px;
  box-shadow: var(--shadow-soft);
  z-index: 20;
}

.msg.sent .msg-actions { right: 8px; }
.msg.received .msg-actions { left: 8px; }

.msg:hover .msg-actions { display: flex; }

.msg-actions button {
  background: none;
  border: none;
  font-size: 16px;
  width: 32px;
  height: 32px;
  cursor: pointer;
  border-radius: 50%;
  transition: background 0.1s;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
}

.msg-actions button:hover {
  background: var(--accent-dim);
}

.msg-actions button svg {
  width: 16px;
  height: 16px;
}

/* ‚îÄ‚îÄ‚îÄ Emoji Picker (expanded from action bar) ‚îÄ‚îÄ‚îÄ */
.emoji-picker {
  position: absolute;
  bottom: calc(100% + 4px);
  display: none;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 6px;
  gap: 2px;
  box-shadow: var(--shadow-soft);
  z-index: 30;
}

.emoji-picker.show { display: flex; }

.msg.sent .emoji-picker { right: 0; }
.msg.received .emoji-picker { left: 0; }

.emoji-picker button {
  background: none;
  border: none;
  font-size: 20px;
  padding: 4px 6px;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.1s;
  line-height: 1;
}

.emoji-picker button:hover {
  background: var(--accent-dim);
}

/* ‚îÄ‚îÄ‚îÄ Reply Preview (quoted message inside bubble) ‚îÄ‚îÄ‚îÄ */
.msg-reply-preview {
  padding: 6px 10px;
  margin-bottom: 6px;
  border-left: 3px solid var(--text-muted);
  border-radius: 6px;
  background: rgba(255, 255, 255, 0.04);
  font-size: 12.5px;
  line-height: 1.4;
  color: var(--text-secondary);
  cursor: pointer;
  max-width: 100%;
  overflow: hidden;
  transition: background 0.15s;
}

.msg-reply-preview:hover {
  background: rgba(255, 255, 255, 0.08);
}

.msg.sent .msg-reply-preview {
  border-left-color: var(--accent);
  background: rgba(232, 164, 74, 0.08);
}

.msg.sent .msg-reply-preview:hover {
  background: rgba(232, 164, 74, 0.14);
}

.msg-reply-preview .reply-author {
  display: block;
  font-size: 11.5px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 1px;
}

.msg.received .msg-reply-preview .reply-author {
  color: var(--text-secondary);
}

.msg-reply-preview .reply-body {
  display: block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text-muted);
  font-size: 12px;
}

/* ‚îÄ‚îÄ‚îÄ Reply Compose Indicator ‚îÄ‚îÄ‚îÄ */
.reply-indicator {
  display: none;
  padding: 8px 16px;
  background: var(--bg-elevated);
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  color: var(--text-secondary);
  align-items: center;
  gap: 8px;
}

.reply-indicator.show { display: flex; }

.reply-indicator .reply-preview {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.reply-indicator .reply-preview span {
  color: var(--accent);
  font-weight: 500;
}

.reply-indicator .reply-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 16px;
  padding: 2px 6px;
  border-radius: 4px;
}

.reply-indicator .reply-close:hover {
  background: var(--cream-soft);
  color: var(--text-primary);
}

.date-divider {
  text-align: center;
  padding: 16px 0 8px;
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.system-msg {
  text-align: center;
  padding: 8px 20px;
  font-size: 12px;
  color: var(--text-muted);
  font-style: italic;
  animation: msgIn 0.25s ease-out;
}

/* ‚îÄ‚îÄ‚îÄ Compose Bar ‚îÄ‚îÄ‚îÄ */
.compose-bar {
  padding: 16px 28px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg-surface);
  display: flex;
  gap: 12px;
  align-items: flex-end;
}

.compose-input {
  flex: 1;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 12px 18px;
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 14.5px;
  line-height: 1.5;
  outline: none;
  resize: none;
  min-height: 44px;
  max-height: 160px;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.compose-input::placeholder { color: var(--text-muted); }

.compose-input:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}

.send-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s, opacity 0.15s;
  flex-shrink: 0;
}

.send-btn:hover { transform: scale(1.06); }
.send-btn:active { transform: scale(0.95); }
.send-btn:disabled { opacity: 0.3; cursor: default; transform: none; }

.send-btn svg {
  width: 20px;
  height: 20px;
  color: var(--bg-deep);
}

/* ‚îÄ‚îÄ‚îÄ Attachment Preview ‚îÄ‚îÄ‚îÄ */
.attach-preview {
  display: none;
  padding: 8px 28px 0;
  border-top: 1px solid var(--border);
  background: var(--bg-surface);
}
.attach-preview.active { display: flex; align-items: center; gap: 10px; }
.attach-preview img {
  max-height: 80px;
  max-width: 120px;
  border-radius: var(--radius-sm);
  object-fit: cover;
}
.attach-preview .attach-name {
  font-size: 12px;
  color: var(--text-secondary);
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.attach-preview .attach-remove {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  padding: 4px 8px;
}
.attach-preview .attach-remove:hover { color: var(--text-primary); }

.attach-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: none;
  border: 1px solid var(--border);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: border-color 0.2s, background 0.2s;
}
.attach-btn:hover {
  border-color: var(--border-accent);
  background: var(--accent-dim);
}
.attach-btn svg {
  width: 20px;
  height: 20px;
  color: var(--text-secondary);
}

/* ‚îÄ‚îÄ‚îÄ Empty State ‚îÄ‚îÄ‚îÄ */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: var(--text-muted);
}

.empty-state-icon {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: var(--accent-dim);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 8px;
}

.empty-state-icon svg {
  width: 28px;
  height: 28px;
  color: var(--accent);
}

.empty-state h2 {
  font-family: var(--font-serif);
  font-size: 22px;
  color: var(--text-secondary);
  font-weight: 400;
}

.empty-state p {
  font-size: 14px;
  color: var(--text-muted);
  max-width: 280px;
  text-align: center;
}

/* ‚îÄ‚îÄ‚îÄ Connection Banner ‚îÄ‚îÄ‚îÄ */
.connection-banner {
  padding: 8px 20px;
  background: var(--accent-dim);
  border-bottom: 1px solid var(--border-accent);
  font-size: 13px;
  color: var(--accent);
  text-align: center;
  display: none;
}

.connection-banner.disconnected {
  display: block;
  background: rgba(220, 80, 60, 0.12);
  border-color: rgba(220, 80, 60, 0.25);
  color: #dc503c;
}

/* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
@media (max-width: 768px) {
  .app { grid-template-columns: 1fr; }
  .sidebar { display: none; }
  .sidebar.mobile-open { display: flex; position: fixed; inset: 0; z-index: 10; }
}

/* ‚îÄ‚îÄ‚îÄ Light Mode ‚îÄ‚îÄ‚îÄ */
@media (prefers-color-scheme: light) {
  :root {
    --bg-deep: #f5f3f0;
    --bg-surface: #ffffff;
    --bg-elevated: #eae7e3;
    --bg-hover: #e2dfdb;
    --text-primary: #1a1816;
    --text-secondary: #5c5650;
    --text-muted: #9a948e;
    --accent: #d4922e;
    --accent-dim: rgba(212, 146, 46, 0.12);
    --accent-glow: rgba(212, 146, 46, 0.06);
    --cream: #1a1816;
    --cream-soft: rgba(26, 24, 22, 0.05);
    --sent-bg: #fdf4e7;
    --received-bg: #ffffff;
    --border: rgba(26, 24, 22, 0.1);
    --border-accent: rgba(212, 146, 46, 0.35);
    --shadow-soft: 0 2px 20px rgba(0,0,0,0.08);
    --shadow-glow: 0 0 40px rgba(212, 146, 46, 0.08);
  }

  /* Scrollbar thumbs */
  .conversation-list::-webkit-scrollbar-thumb {
    background: rgba(26, 24, 22, 0.2);
  }

  .messages-area::-webkit-scrollbar-thumb {
    background: rgba(26, 24, 22, 0.15);
  }

  /* Sent message border override (hard-coded in dark mode) */
  .msg.sent {
    border-color: rgba(212, 146, 46, 0.2);
  }

  /* Sent message time color */
  .msg.sent .msg-time {
    color: rgba(26, 24, 22, 0.4);
  }

  /* Send button icon color */
  .send-btn svg {
    color: #ffffff;
  }

  /* Fullscreen overlay slightly lighter backdrop */
  .msg-image-fullscreen {
    background: rgba(0, 0, 0, 0.75);
  }

  /* Reaction pill background uses a light surface */
  .reaction-pill {
    background: var(--bg-surface);
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  }

  /* Disconnection banner: soften red tones for light mode */
  .connection-banner.disconnected {
    background: rgba(220, 80, 60, 0.08);
    border-color: rgba(220, 80, 60, 0.2);
  }

  /* Reply preview: use dark-based tints for light mode */
  .msg-reply-preview {
    background: rgba(0, 0, 0, 0.04);
  }

  .msg-reply-preview:hover {
    background: rgba(0, 0, 0, 0.07);
  }

  .msg.sent .msg-reply-preview {
    background: rgba(212, 146, 46, 0.1);
  }

  .msg.sent .msg-reply-preview:hover {
    background: rgba(212, 146, 46, 0.16);
  }
}
</style>
</head>
<body>

<div class="app" id="app">
  <!-- Left Rail -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1>Open<span>Messages</span></h1>
    </div>
    <div class="search-box">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="search-input" placeholder="Search messages..." autocomplete="off">
    </div>
    <div class="conversation-list" id="conversation-list"></div>
  </div>

  <!-- Right Pane -->
  <div class="chat-pane" id="chat-pane">
    <div class="connection-banner" id="connection-banner">
      Not connected to Google Messages
    </div>

    <!-- Empty state (shown when no conversation selected) -->
    <div class="empty-state" id="empty-state">
      <div class="empty-state-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <h2>Your messages</h2>
      <p>Select a conversation to start messaging, or wait for new messages to arrive.</p>
    </div>

    <!-- Chat view (hidden until conversation selected) -->
    <div class="chat-header" id="chat-header" style="display:none">
      <div class="chat-header-avatar" id="chat-header-avatar"></div>
      <div>
        <div class="chat-header-name" id="chat-header-name"></div>
        <div class="chat-header-status" id="chat-header-status"></div>
      </div>
    </div>
    <div class="messages-area" id="messages-area" style="display:none"></div>
    <div class="reply-indicator" id="reply-indicator">
      <div class="reply-preview">Replying to <span id="reply-to-name"></span>: <span id="reply-to-text"></span></div>
      <button class="reply-close" id="reply-close">&times;</button>
    </div>
    <div class="attach-preview" id="attach-preview">
      <img id="attach-thumb" alt="Preview">
      <span class="attach-name" id="attach-name"></span>
      <button class="attach-remove" id="attach-remove">&times;</button>
    </div>
    <div class="compose-bar" id="compose-bar" style="display:none">
      <input type="file" id="file-input" accept="image/*,video/*" style="display:none">
      <button class="attach-btn" id="attach-btn" title="Attach image">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      </button>
      <textarea class="compose-input" id="compose-input" placeholder="Write a message..." rows="1"></textarea>
      <button class="send-btn" id="send-btn" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const API = '';
  let activeConvoId = null;
  let conversations = [];
  let pollTimer = null;

  // ‚îÄ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ
  const $convoList = document.getElementById('conversation-list');
  const $emptyState = document.getElementById('empty-state');
  const $chatHeader = document.getElementById('chat-header');
  const $chatHeaderAvatar = document.getElementById('chat-header-avatar');
  const $chatHeaderName = document.getElementById('chat-header-name');
  const $chatHeaderStatus = document.getElementById('chat-header-status');
  const $messagesArea = document.getElementById('messages-area');
  const $composeBar = document.getElementById('compose-bar');
  const $composeInput = document.getElementById('compose-input');
  const $sendBtn = document.getElementById('send-btn');
  const $fileInput = document.getElementById('file-input');
  const $attachBtn = document.getElementById('attach-btn');
  const $attachPreview = document.getElementById('attach-preview');
  const $attachThumb = document.getElementById('attach-thumb');
  const $attachName = document.getElementById('attach-name');
  const $attachRemove = document.getElementById('attach-remove');
  let pendingFile = null; // { file: File, dataUrl: string }
  const $searchInput = document.getElementById('search-input');
  const $connectionBanner = document.getElementById('connection-banner');
  const $replyIndicator = document.getElementById('reply-indicator');
  const $replyToName = document.getElementById('reply-to-name');
  const $replyToText = document.getElementById('reply-to-text');
  const $replyClose = document.getElementById('reply-close');

  let replyToMsg = null; // {MessageID, SenderName, Body}
  const QUICK_EMOJIS = ['üòÇ', '‚ù§Ô∏è', 'üëç', 'üòÆ', 'üò¢', 'üôè'];

  // ‚îÄ‚îÄ‚îÄ Avatar Colors ‚îÄ‚îÄ‚îÄ
  // Pleasant, muted palette that works on both dark and light backgrounds
  const AVATAR_COLORS = [
    '#5B8DEF', // blue
    '#43A692', // teal
    '#E8895C', // coral
    '#9B72CF', // purple
    '#D4644E', // terracotta
    '#5CAE6E', // green
    '#CB7EB5', // mauve
    '#6A9FD8', // sky
    '#C4965A', // amber
    '#7E8CC8', // periwinkle
  ];

  function avatarColor(name) {
    if (!name) return AVATAR_COLORS[0];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = ((hash << 5) - hash + name.charCodeAt(i)) | 0;
    }
    return AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length];
  }

  // Track whether the active conversation is a group chat
  let activeConvoIsGroup = false;

  // ‚îÄ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ
  function initials(name) {
    if (!name) return '?';
    return name.split(/\s+/).map(w => w[0]).slice(0, 2).join('').toUpperCase();
  }

  function formatTime(ms) {
    if (!ms) return '';
    const d = new Date(ms);
    const now = new Date();
    const diffDays = Math.floor((now - d) / 86400000);
    if (diffDays === 0) {
      return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    } else if (diffDays === 1) {
      return 'Yesterday';
    } else if (diffDays < 7) {
      return d.toLocaleDateString([], { weekday: 'short' });
    }
    return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
  }

  function formatMessageTime(ms) {
    if (!ms) return '';
    return new Date(ms).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
  }

  function isSameDay(ms1, ms2) {
    const a = new Date(ms1), b = new Date(ms2);
    return a.getFullYear() === b.getFullYear() &&
           a.getMonth() === b.getMonth() &&
           a.getDate() === b.getDate();
  }

  function formatDateDivider(ms) {
    const d = new Date(ms);
    const now = new Date();
    const diffDays = Math.floor((now - d) / 86400000);
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    return d.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
  }

  // ‚îÄ‚îÄ‚îÄ Message Status Indicator ‚îÄ‚îÄ‚îÄ
  function formatStatusIndicator(status) {
    if (!status) return '';
    const s = status.toUpperCase();
    // Sending states
    if (s.includes('SENDING') || s.includes('YET_TO_SEND') || s.includes('RESENDING') ||
        s.includes('VALIDATING') || s.includes('SEND_AFTER_PROCESSING') ||
        s.includes('NOT_DELIVERED_YET')) {
      return '<span class="msg-status status-sending" title="Sending">\u23F3</span>';
    }
    // Read/displayed
    if (s.includes('DISPLAYED')) {
      return '<span class="msg-status status-read" title="Read">\u2713\u2713</span>';
    }
    // Delivered
    if (s.includes('DELIVERED')) {
      return '<span class="msg-status status-delivered" title="Delivered">\u2713\u2713</span>';
    }
    // Failed states
    if (s.includes('FAILED') || s.includes('CANCELED')) {
      return '<span class="msg-status status-failed" title="Failed">!</span>';
    }
    // Sent/complete (default for outgoing)
    if (s.includes('COMPLETE') || s.includes('OUTGOING')) {
      return '<span class="msg-status status-sent" title="Sent">\u2713</span>';
    }
    return '';
  }

  // ‚îÄ‚îÄ‚îÄ API calls ‚îÄ‚îÄ‚îÄ
  async function fetchJSON(url) {
    const r = await fetch(API + url);
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  async function postJSON(url, body) {
    const r = await fetch(API + url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    return r.json();
  }

  // ‚îÄ‚îÄ‚îÄ Render Conversations ‚îÄ‚îÄ‚îÄ
  function renderConversations(convos, isSearch) {
    if (!isSearch) conversations = convos;
    $convoList.innerHTML = '';
    if (!convos.length) {
      const emptyMsg = isSearch ? 'No results found' : 'No conversations yet';
      $convoList.innerHTML = `<div style="padding:40px 20px;text-align:center;color:var(--text-muted);font-size:13px">${emptyMsg}</div>`;
      return;
    }
    convos.forEach(c => {
      const el = document.createElement('div');
      const hasUnread = c.UnreadCount > 0;
      el.className = 'convo-item'
        + (c.ConversationID === activeConvoId ? ' active' : '')
        + (hasUnread ? ' unread' : '');
      el.dataset.id = c.ConversationID;
      const preview = c._searchPreview
        ? escapeHtml(c._searchPreview.substring(0, 60))
        : '&nbsp;';
      el.innerHTML = `
        <div class="convo-avatar" style="background:${avatarColor(c.Name)}">${initials(c.Name)}</div>
        <div class="convo-meta">
          <div class="convo-name">${escapeHtml(c.Name || 'Unknown')}</div>
          <div class="convo-preview">${preview}</div>
        </div>
        <div class="convo-time">${formatTime(c.LastMessageTS)}</div>
        ${hasUnread ? '<div class="convo-unread">' + c.UnreadCount + '</div>' : ''}
      `;
      el.addEventListener('click', () => selectConversation(c));
      $convoList.appendChild(el);
    });

    // Update page title with total unread count
    updateTitleUnreadCount(convos);
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function updateTitleUnreadCount(convos) {
    const total = convos.reduce((sum, c) => sum + (c.UnreadCount || 0), 0);
    document.title = total > 0 ? `(${total}) OpenMessages` : 'OpenMessages';
  }

  // ‚îÄ‚îÄ‚îÄ Select Conversation ‚îÄ‚îÄ‚îÄ
  async function selectConversation(convo) {
    activeConvoId = convo.ConversationID;

    // Update sidebar active state
    document.querySelectorAll('.convo-item').forEach(el => {
      el.classList.toggle('active', el.dataset.id === activeConvoId);
    });

    // Show chat UI
    $emptyState.style.display = 'none';
    $chatHeader.style.display = 'flex';
    $messagesArea.style.display = 'flex';
    $composeBar.style.display = 'flex';

    $chatHeaderAvatar.textContent = initials(convo.Name);
    $chatHeaderAvatar.style.background = avatarColor(convo.Name);
    $chatHeaderName.textContent = convo.Name || 'Unknown';
    activeConvoIsGroup = !!convo.IsGroup;
    // Set default header status before loading messages
    if (convo.IsGroup) {
      $chatHeaderStatus.textContent = 'Group chat';
    } else {
      $chatHeaderStatus.textContent = '';
    }
    lastMsgCount = -1; // Force re-render on conversation switch
    await loadMessages(convo.ConversationID);

    // Start polling for new messages
    clearInterval(pollTimer);
    pollTimer = setInterval(() => loadMessages(activeConvoId), 3000);
  }

  // ‚îÄ‚îÄ‚îÄ Load Messages ‚îÄ‚îÄ‚îÄ
  let lastMsgCount = 0;

  async function loadMessages(convoId) {
    try {
      const msgs = await fetchJSON(`/api/conversations/${convoId}/messages?limit=200`);
      // Reverse: API returns DESC, we want oldest first
      msgs.reverse();

      if (msgs.length === lastMsgCount && convoId === activeConvoId) return;
      lastMsgCount = msgs.length;

      const wasAtBottom = $messagesArea.scrollHeight - $messagesArea.scrollTop - $messagesArea.clientHeight < 60;

      $messagesArea.innerHTML = '';
      let lastDate = 0;
      let lastSenderName = null; // Track consecutive messages from same sender

      msgs.forEach((m, mi) => {
        // Date divider
        if (!isSameDay(m.TimestampMS, lastDate)) {
          const divider = document.createElement('div');
          divider.className = 'date-divider';
          divider.textContent = formatDateDivider(m.TimestampMS);
          $messagesArea.appendChild(divider);
          lastDate = m.TimestampMS;
        }

        // System/tombstone messages (protocol switches, chat creation)
        if ((m.Status || '').startsWith('TOMBSTONE_')) {
          const sysEl = document.createElement('div');
          sysEl.className = 'system-msg';
          let sysText = m.Body || '';
          if (m.Status.includes('RCS')) {
            sysText = 'üîí ' + sysText;
          } else if (m.Status.includes('TEXT') || m.Status.includes('SMS')) {
            sysText = 'üí¨ ' + sysText;
          }
          sysEl.textContent = sysText;
          $messagesArea.appendChild(sysEl);
          return;
        }

        const el = document.createElement('div');
        el.className = 'msg ' + (m.IsFromMe ? 'sent' : 'received');

        let html = '';

        // Reply banner
        if (m.ReplyToID) {
          const original = msgs.find(om => om.MessageID === m.ReplyToID);
          const origName = original ? (original.SenderName || 'You') : '';
          const origBody = original ? (original.Body || 'Media') : 'Original message';
          const truncBody = origBody.length > 60 ? origBody.substring(0, 60) + '\u2026' : origBody;
          html += `<div class="msg-reply-preview" data-reply-id="${escapeHtml(m.ReplyToID)}" onclick="scrollToMessage('${escapeHtml(m.ReplyToID)}')"><span class="reply-author">${escapeHtml(origName)}</span><span class="reply-body">${escapeHtml(truncBody)}</span></div>`;
        }

        if (!m.IsFromMe && m.SenderName) {
          html += `<div class="msg-sender" style="color:${avatarColor(m.SenderName)}">${escapeHtml(m.SenderName)}</div>`;
        }
        if (m.MediaID) {
          const mimeType = (m.MimeType || '').toLowerCase();
          const isImage = mimeType.startsWith('image/');
          const isVideo = mimeType.startsWith('video/');
          const mediaSrc = `/api/media/${encodeURIComponent(m.MessageID)}`;
          const safeId = CSS.escape(m.MessageID);

          if (isImage) {
            html += `<div class="msg-media">`;
            html += `<div class="msg-media-loading" id="media-loading-${safeId}"><div class="spinner"></div>Loading image...</div>`;
            html += `<img src="${mediaSrc}" alt="Image" style="display:none" onload="this.style.display='block';var ldr=document.getElementById('media-loading-${safeId}');if(ldr)ldr.remove();" onerror="var ldr=document.getElementById('media-loading-${safeId}');if(ldr){ldr.innerHTML='Failed to load image';ldr.querySelector('.spinner')&&ldr.querySelector('.spinner').remove();}" onclick="showFullscreen(this.src,'image')">`;
            html += `</div>`;
          } else if (isVideo) {
            html += `<div class="msg-media">`;
            html += `<div class="msg-media-loading" id="media-loading-${safeId}"><div class="spinner"></div>Loading video...</div>`;
            html += `<video src="${mediaSrc}" preload="metadata" controls playsinline style="display:none" onloadeddata="this.style.display='block';var ldr=document.getElementById('media-loading-${safeId}');if(ldr)ldr.remove();" onerror="var ldr=document.getElementById('media-loading-${safeId}');if(ldr){ldr.innerHTML='Failed to load video';}" onclick="event.stopPropagation()"></video>`;
            html += `</div>`;
          } else {
            html += `<div style="font-size:13px;color:var(--text-secondary);padding:6px 0">Attachment: ${escapeHtml(m.MimeType || 'file')}</div>`;
          }
        } else if (m.MimeType) {
          // Media metadata exists but media ID expired/unavailable
          const mimeType = (m.MimeType || '').toLowerCase();
          const icon = mimeType.startsWith('image/') ? '\uD83D\uDDBC\uFE0F' : mimeType.startsWith('video/') ? '\uD83C\uDFA5' : '\uD83D\uDCCE';
          html += `<div style="font-size:13px;color:var(--text-muted);padding:6px 0">${icon} ${escapeHtml(m.MimeType)} (media unavailable)</div>`;
        }
        if (m.Body) {
          html += `<div class="msg-body">${escapeHtml(m.Body)}</div>`;
        }
        if (!m.Body && !m.MediaID) {
          html += `<div class="msg-body" style="color:var(--text-muted);font-style:italic">Empty message</div>`;
        }

        // Reactions
        if (m.Reactions) {
          try {
            const reactions = JSON.parse(m.Reactions);
            if (reactions.length > 0) {
              html += '<div class="msg-reactions">';
              reactions.forEach(r => {
                html += `<span class="reaction-pill" title="${r.count} reaction${r.count > 1 ? 's' : ''}">${r.emoji}<span class="reaction-count">${r.count > 1 ? r.count : ''}</span></span>`;
              });
              html += '</div>';
            }
          } catch(e) {}
        }

        html += `<div class="msg-time">${formatMessageTime(m.TimestampMS)}${m.IsFromMe ? formatStatusIndicator(m.Status) : ''}</div>`;

        // Hover action bar (Google Messages style)
        html += `<div class="msg-actions">`;
        html += `<button class="action-react" title="React">üòÄ</button>`;
        html += `<button class="action-reply" title="Reply"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg></button>`;
        html += `</div>`;

        // Emoji picker (hidden, toggled by react button)
        html += `<div class="emoji-picker" id="emoji-${m.MessageID}">`;
        QUICK_EMOJIS.forEach(e => {
          html += `<button onclick="sendReaction('${m.MessageID}','${e}')">${e}</button>`;
        });
        html += '</div>';

        el.innerHTML = html;
        el.dataset.msgId = m.MessageID;

        // Action bar: React button ‚Üí toggle emoji picker
        el.querySelector('.action-react').addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('.emoji-picker.show').forEach(p => p.classList.remove('show'));
          const picker = document.getElementById('emoji-' + m.MessageID);
          if (picker) picker.classList.toggle('show');
        });

        // Action bar: Reply button
        el.querySelector('.action-reply').addEventListener('click', (e) => {
          e.stopPropagation();
          setReplyTo(m);
        });

        // In group chats, wrap received messages with an avatar
        if (activeConvoIsGroup && !m.IsFromMe && m.SenderName) {
          // Show avatar only for the last message in a consecutive run from the same sender
          const nextMsg = msgs[mi + 1];
          const isLastFromSender = !nextMsg || nextMsg.IsFromMe || nextMsg.SenderName !== m.SenderName ||
            (nextMsg.Status || '').startsWith('TOMBSTONE_') || !isSameDay(m.TimestampMS, nextMsg.TimestampMS);

          const row = document.createElement('div');
          row.className = 'msg-row received';
          const avatarDiv = document.createElement('div');
          avatarDiv.className = 'msg-avatar' + (isLastFromSender ? '' : ' avatar-hidden');
          avatarDiv.style.background = avatarColor(m.SenderName);
          avatarDiv.textContent = initials(m.SenderName).charAt(0);
          row.appendChild(avatarDiv);
          row.appendChild(el);
          $messagesArea.appendChild(row);
        } else {
          $messagesArea.appendChild(el);
        }
        lastSenderName = m.IsFromMe ? null : m.SenderName;
      });

      // Update protocol indicator in header from most recent tombstone
      // msgs are in chronological order (oldest first), so findLast gets the latest
      const lastTombstone = msgs.findLast(m => (m.Status || '').startsWith('TOMBSTONE_'));
      if (lastTombstone) {
        if (lastTombstone.Status.includes('RCS')) {
          $chatHeaderStatus.innerHTML = '<span style="color:#4a9;">üîí RCS</span>';
        } else if (lastTombstone.Status.includes('TEXT') || lastTombstone.Status.includes('SMS')) {
          $chatHeaderStatus.innerHTML = '<span style="color:var(--text-muted)">SMS</span>';
        }
      }

      if (wasAtBottom || msgs.length !== lastMsgCount) {
        $messagesArea.scrollTop = $messagesArea.scrollHeight;
      }
    } catch (err) {
      console.error('Failed to load messages:', err);
    }
  }

  // ‚îÄ‚îÄ‚îÄ Send Message ‚îÄ‚îÄ‚îÄ
  async function sendMessage() {
    const text = $composeInput.value.trim();
    const hasMedia = !!pendingFile;
    if ((!text && !hasMedia) || !activeConvoId) return;

    $composeInput.value = '';
    $sendBtn.disabled = true;
    autoResize();

    try {
      if (hasMedia) {
        // Send media via multipart form
        const form = new FormData();
        form.append('conversation_id', activeConvoId);
        form.append('file', pendingFile.file);
        const resp = await fetch('/api/send-media', { method: 'POST', body: form });
        if (!resp.ok) throw new Error(await resp.text());
        clearAttachment();
      }
      if (text) {
        const payload = {
          conversation_id: activeConvoId,
          message: text,
        };
        if (replyToMsg) {
          payload.reply_to_id = replyToMsg.MessageID;
        }
        await postJSON('/api/send', payload);
      }
      clearReply();
      // Wait briefly for server echo to arrive, then force re-render
      if (hasMedia) await new Promise(r => setTimeout(r, 1500));
      lastMsgCount = -1;
      await loadMessages(activeConvoId);
      await loadConversations();
    } catch (err) {
      console.error('Failed to send:', err);
    }
  }

  // ‚îÄ‚îÄ‚îÄ Compose Input ‚îÄ‚îÄ‚îÄ
  function autoResize() {
    $composeInput.style.height = 'auto';
    $composeInput.style.height = Math.min($composeInput.scrollHeight, 160) + 'px';
    $sendBtn.disabled = !$composeInput.value.trim();
  }

  $composeInput.addEventListener('input', autoResize);
  $composeInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  $sendBtn.addEventListener('click', sendMessage);

  // ‚îÄ‚îÄ‚îÄ Attachments (paste + file picker) ‚îÄ‚îÄ‚îÄ
  function setAttachment(file) {
    pendingFile = { file };
    $attachName.textContent = file.name || 'Pasted image';
    $attachPreview.classList.add('active');
    $sendBtn.disabled = false;

    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = e => { $attachThumb.src = e.target.result; $attachThumb.style.display = 'block'; };
      reader.readAsDataURL(file);
    } else {
      $attachThumb.style.display = 'none';
    }
  }

  function clearAttachment() {
    pendingFile = null;
    $attachPreview.classList.remove('active');
    $attachThumb.src = '';
    $attachName.textContent = '';
    $fileInput.value = '';
    autoResize();
  }

  // Paste handler: Ctrl+V / Cmd+V with image data
  $composeInput.addEventListener('paste', e => {
    const items = e.clipboardData?.items;
    if (!items) return;
    for (const item of items) {
      if (item.kind === 'file' && item.type.startsWith('image/')) {
        e.preventDefault();
        const file = item.getAsFile();
        if (file) setAttachment(file);
        return;
      }
    }
  });

  // File picker button
  $attachBtn.addEventListener('click', () => $fileInput.click());
  $fileInput.addEventListener('change', () => {
    if ($fileInput.files[0]) setAttachment($fileInput.files[0]);
  });
  $attachRemove.addEventListener('click', clearAttachment);

  // ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ
  let searchTimeout;
  $searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    const q = $searchInput.value.trim();
    if (!q) {
      loadConversations();
      return;
    }
    searchTimeout = setTimeout(async () => {
      try {
        const results = await fetchJSON(`/api/search?q=${encodeURIComponent(q)}&limit=30`);
        // Group search results by conversation, resolve names from conversations list
        const convoMap = {};
        conversations.forEach(c => { convoMap[c.ConversationID] = c; });
        const byConvo = {};
        results.forEach(m => {
          if (!byConvo[m.ConversationID]) {
            const convo = convoMap[m.ConversationID];
            byConvo[m.ConversationID] = {
              id: m.ConversationID,
              name: convo ? convo.Name : (m.SenderName || 'Unknown'),
              body: m.Body,
              ts: m.TimestampMS,
              isGroup: convo ? convo.IsGroup : false,
            };
          }
        });
        const searchConvos = Object.values(byConvo).map(c => ({
          ConversationID: c.id,
          Name: c.name || 'Unknown',
          LastMessageTS: c.ts,
          IsGroup: c.isGroup,
          _searchPreview: c.body,
        }));
        renderConversations(searchConvos, true);
      } catch (err) {
        console.error('Search failed:', err);
      }
    }, 300);
  });

  // ‚îÄ‚îÄ‚îÄ Status Check ‚îÄ‚îÄ‚îÄ
  async function checkStatus() {
    try {
      const status = await fetchJSON('/api/status');
      if (status.connected) {
        $connectionBanner.className = 'connection-banner';
      } else {
        $connectionBanner.className = 'connection-banner disconnected';
      }
    } catch {
      $connectionBanner.className = 'connection-banner disconnected';
    }
  }

  // ‚îÄ‚îÄ‚îÄ Load Conversations ‚îÄ‚îÄ‚îÄ
  async function loadConversations() {
    try {
      const convos = await fetchJSON('/api/conversations?limit=50');
      renderConversations(convos);
    } catch (err) {
      console.error('Failed to load conversations:', err);
    }
  }

  // ‚îÄ‚îÄ‚îÄ Reactions ‚îÄ‚îÄ‚îÄ
  window.sendReaction = async function(messageId, emoji) {
    // Close picker
    document.querySelectorAll('.emoji-picker.show').forEach(p => p.classList.remove('show'));
    try {
      await postJSON('/api/react', {
        message_id: messageId,
        emoji: emoji,
        conversation_id: activeConvoId,
        action: 'add',
      });
      // Reload to see updated reactions
      if (activeConvoId) await loadMessages(activeConvoId);
    } catch (err) {
      console.error('Failed to send reaction:', err);
    }
  };

  // Close react picker when clicking elsewhere
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.emoji-picker') && !e.target.closest('.msg-actions')) {
      document.querySelectorAll('.emoji-picker.show').forEach(p => p.classList.remove('show'));
    }
  });

  // ‚îÄ‚îÄ‚îÄ Reply ‚îÄ‚îÄ‚îÄ
  function setReplyTo(msg) {
    replyToMsg = msg;
    $replyToName.textContent = msg.SenderName || 'You';
    $replyToText.textContent = (msg.Body || 'Media').substring(0, 80);
    $replyIndicator.classList.add('show');
    $composeInput.focus();
  }

  function clearReply() {
    replyToMsg = null;
    $replyIndicator.classList.remove('show');
  }

  $replyClose.addEventListener('click', clearReply);

  window.scrollToMessage = function(msgId) {
    const el = document.querySelector(`[data-msg-id="${msgId}"]`);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      el.style.outline = '2px solid var(--accent)';
      setTimeout(() => { el.style.outline = ''; }, 1500);
    }
  };

  // ‚îÄ‚îÄ‚îÄ Fullscreen Media Viewer ‚îÄ‚îÄ‚îÄ
  window.showFullscreen = function(src, type) {
    const overlay = document.createElement('div');
    overlay.className = 'msg-image-fullscreen';

    if (type === 'video') {
      overlay.innerHTML = `<video src="${src}" controls autoplay playsinline></video><button class="fullscreen-close">&times;</button>`;
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay || e.target.classList.contains('fullscreen-close')) {
          const vid = overlay.querySelector('video');
          if (vid) vid.pause();
          overlay.remove();
        }
      });
    } else {
      overlay.innerHTML = `<img src="${src}" alt="Full size"><button class="fullscreen-close">&times;</button>`;
      overlay.addEventListener('click', () => overlay.remove());
    }

    document.body.appendChild(overlay);
  };

  // ‚îÄ‚îÄ‚îÄ Keyboard Shortcuts ‚îÄ‚îÄ‚îÄ
  // Helper: get ordered list of conversation items in the sidebar
  function getConvoItems() {
    return Array.from($convoList.querySelectorAll('.convo-item'));
  }

  // Helper: index of currently active conversation in sidebar list
  function getActiveConvoIndex() {
    const items = getConvoItems();
    return items.findIndex(el => el.classList.contains('active'));
  }

  // Helper: select conversation at a given index in the sidebar list
  function selectConvoByIndex(idx) {
    const items = getConvoItems();
    if (items.length === 0) return;
    const clamped = Math.max(0, Math.min(idx, items.length - 1));
    items[clamped].click();
    items[clamped].scrollIntoView({ block: 'nearest' });
  }

  // Helper: deselect current conversation and return to empty state
  function deselectConversation() {
    activeConvoId = null;
    activeConvoIsGroup = false;
    clearInterval(pollTimer);
    document.querySelectorAll('.convo-item').forEach(el => el.classList.remove('active'));
    $emptyState.style.display = '';
    $chatHeader.style.display = 'none';
    $messagesArea.style.display = 'none';
    $composeBar.style.display = 'none';
    $messagesArea.innerHTML = '';
    clearReply();
  }

  document.addEventListener('keydown', function(e) {
    const tag = (e.target.tagName || '').toLowerCase();
    const isInput = (tag === 'input' || tag === 'textarea' || e.target.isContentEditable);
    const mod = e.metaKey || e.ctrlKey;

    // ‚îÄ‚îÄ Cmd/Ctrl+K: Focus search (works everywhere) ‚îÄ‚îÄ
    if (mod && e.key === 'k') {
      e.preventDefault();
      $searchInput.focus();
      $searchInput.select();
      return;
    }

    // ‚îÄ‚îÄ Escape: works everywhere ‚îÄ‚îÄ
    if (e.key === 'Escape') {
      e.preventDefault();
      // Close fullscreen image viewer if open
      const fullscreen = document.querySelector('.msg-image-fullscreen');
      if (fullscreen) { fullscreen.remove(); return; }
      // Close any open emoji pickers
      const openPickers = document.querySelectorAll('.emoji-picker.show');
      if (openPickers.length) { openPickers.forEach(p => p.classList.remove('show')); return; }
      // Clear search if there is text
      if ($searchInput.value.trim()) {
        $searchInput.value = '';
        loadConversations();
        $searchInput.blur();
        return;
      }
      // Clear reply indicator if showing
      if (replyToMsg) { clearReply(); return; }
      // Deselect conversation
      if (activeConvoId) { deselectConversation(); return; }
      // Blur any focused input
      if (document.activeElement) document.activeElement.blur();
      return;
    }

    // ‚îÄ‚îÄ Cmd/Ctrl+N: New message / focus compose (works everywhere) ‚îÄ‚îÄ
    if (mod && e.key === 'n') {
      e.preventDefault();
      if (activeConvoId) {
        $composeInput.focus();
      } else {
        // No conversation selected ‚Äî focus search so user can find/start one
        $searchInput.focus();
        $searchInput.select();
      }
      return;
    }

    // ‚îÄ‚îÄ Cmd/Ctrl+Shift+] : Next conversation (works everywhere) ‚îÄ‚îÄ
    if (mod && e.shiftKey && e.key === ']') {
      e.preventDefault();
      const idx = getActiveConvoIndex();
      selectConvoByIndex(idx + 1);
      return;
    }

    // ‚îÄ‚îÄ Cmd/Ctrl+Shift+[ : Previous conversation (works everywhere) ‚îÄ‚îÄ
    if (mod && e.shiftKey && e.key === '[') {
      e.preventDefault();
      const idx = getActiveConvoIndex();
      selectConvoByIndex(idx < 0 ? 0 : idx - 1);
      return;
    }

    // ‚îÄ‚îÄ The remaining shortcuts should NOT fire when typing in inputs ‚îÄ‚îÄ
    if (isInput) return;

    // ‚îÄ‚îÄ Up/Down arrows: Navigate conversations in sidebar ‚îÄ‚îÄ
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      const idx = getActiveConvoIndex();
      selectConvoByIndex(idx + 1);
      return;
    }

    if (e.key === 'ArrowUp') {
      e.preventDefault();
      const idx = getActiveConvoIndex();
      selectConvoByIndex(idx < 0 ? 0 : idx - 1);
      return;
    }
  });

  // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
  loadConversations();
  checkStatus();
  setInterval(checkStatus, 10000);
  setInterval(() => {
    if (!$searchInput.value.trim()) loadConversations();
  }, 5000);
})();
</script>
</body>
</html>
