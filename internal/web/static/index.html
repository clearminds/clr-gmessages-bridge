<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenMessages</title>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #111111;
  --bg-surface: #1a1a1a;
  --bg-elevated: #242424;
  --bg-hover: #2e2e2e;
  --text-primary: #faf6f1;
  --text-secondary: #a09890;
  --text-muted: #6b6560;
  --accent: #e8a44a;
  --accent-dim: rgba(232, 164, 74, 0.15);
  --accent-glow: rgba(232, 164, 74, 0.08);
  --cream: #faf6f1;
  --cream-soft: rgba(250, 246, 241, 0.06);
  --sent-bg: #2a2520;
  --received-bg: #1e1e1e;
  --border: rgba(250, 246, 241, 0.06);
  --border-accent: rgba(232, 164, 74, 0.25);
  --radius-sm: 4px;
  --radius-md: 12px;
  --radius-lg: 20px;
  --font-serif: 'Instrument Serif', Georgia, serif;
  --font-sans: 'DM Sans', -apple-system, sans-serif;
  --shadow-soft: 0 2px 20px rgba(0,0,0,0.3);
  --shadow-glow: 0 0 40px rgba(232, 164, 74, 0.06);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  height: 100%;
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 15px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  overflow: hidden;
}

/* â”€â”€â”€ Layout â”€â”€â”€ */
.app {
  display: grid;
  grid-template-columns: 340px 1fr;
  height: 100vh;
}

/* â”€â”€â”€ Left Rail: Conversation List â”€â”€â”€ */
.sidebar {
  background: var(--bg-surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}

.sidebar-header h1 {
  font-family: var(--font-serif);
  font-size: 28px;
  font-weight: 400;
  letter-spacing: -0.5px;
  color: var(--text-primary);
}

.sidebar-header h1 span {
  color: var(--accent);
}

.search-box {
  margin: 16px 20px 12px;
  position: relative;
}

.search-box input {
  width: 100%;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 10px 16px 10px 40px;
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.search-box input::placeholder { color: var(--text-muted); }

.search-box input:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}

.search-box svg {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  width: 16px;
  height: 16px;
}

.conversation-list {
  flex: 1;
  overflow-y: auto;
  padding: 4px 8px;
}

.conversation-list::-webkit-scrollbar { width: 4px; }
.conversation-list::-webkit-scrollbar-track { background: transparent; }
.conversation-list::-webkit-scrollbar-thumb {
  background: var(--text-muted);
  border-radius: 2px;
}

.convo-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}

.convo-item:hover { background: var(--bg-hover); }

.convo-item.active {
  background: var(--accent-dim);
}

.convo-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 3px;
  height: 28px;
  background: var(--accent);
  border-radius: 0 2px 2px 0;
}

.convo-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-serif);
  font-size: 18px;
  color: var(--accent);
  flex-shrink: 0;
  border: 1px solid var(--border);
}

.convo-item.active .convo-avatar {
  border-color: var(--border-accent);
  box-shadow: var(--shadow-glow);
}

.convo-meta {
  flex: 1;
  min-width: 0;
}

.convo-name {
  font-family: var(--font-serif);
  font-size: 16px;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.convo-preview {
  font-size: 13px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 2px;
}

.convo-time {
  font-size: 11px;
  color: var(--text-muted);
  flex-shrink: 0;
  align-self: flex-start;
  margin-top: 2px;
}

.convo-unread {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent);
  position: absolute;
  right: 16px;
  bottom: 14px;
}

/* â”€â”€â”€ Right Pane: Messages â”€â”€â”€ */
.chat-pane {
  display: flex;
  flex-direction: column;
  background: var(--bg-deep);
  overflow: hidden;
}

.chat-header {
  padding: 20px 28px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  display: flex;
  align-items: center;
  gap: 14px;
}

.chat-header-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-serif);
  font-size: 16px;
  color: var(--accent);
  border: 1px solid var(--border-accent);
}

.chat-header-name {
  font-family: var(--font-serif);
  font-size: 20px;
  font-weight: 400;
}

.chat-header-status {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 1px;
}

.messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 24px 28px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.messages-area::-webkit-scrollbar { width: 4px; }
.messages-area::-webkit-scrollbar-track { background: transparent; }
.messages-area::-webkit-scrollbar-thumb {
  background: rgba(250, 246, 241, 0.1);
  border-radius: 2px;
}

.msg {
  max-width: 520px;
  padding: 10px 16px;
  border-radius: var(--radius-lg);
  font-size: 14.5px;
  line-height: 1.55;
  animation: msgIn 0.25s ease-out;
  position: relative;
}

@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.sent {
  align-self: flex-end;
  background: var(--sent-bg);
  color: var(--cream);
  border-bottom-right-radius: var(--radius-sm);
  border: 1px solid rgba(232, 164, 74, 0.12);
}

.msg.received {
  align-self: flex-start;
  background: var(--received-bg);
  color: var(--text-primary);
  border-bottom-left-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

.msg-sender {
  font-size: 12px;
  font-weight: 500;
  color: var(--accent);
  margin-bottom: 3px;
  font-family: var(--font-sans);
}

.msg-time {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
  text-align: right;
}

.msg.sent .msg-time { color: rgba(250, 246, 241, 0.35); }

.msg-image {
  max-width: 320px;
  max-height: 400px;
  border-radius: var(--radius-md);
  margin: 4px 0;
  cursor: pointer;
  display: block;
  background: var(--bg-elevated);
  min-height: 80px;
  object-fit: contain;
}

.msg-image-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 200px;
  height: 120px;
  border-radius: var(--radius-md);
  background: var(--bg-elevated);
  color: var(--text-muted);
  font-size: 12px;
  margin: 4px 0;
}

.msg.sent .msg-image { margin-left: auto; }

.msg-image-fullscreen {
  position: fixed;
  inset: 0;
  z-index: 100;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: zoom-out;
}

.msg-image-fullscreen img {
  max-width: 90vw;
  max-height: 90vh;
  object-fit: contain;
  border-radius: var(--radius-md);
}

/* â”€â”€â”€ Reactions â”€â”€â”€ */
.msg-reactions {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 6px;
}

.reaction-pill {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  padding: 2px 8px;
  border-radius: 12px;
  background: var(--cream-soft);
  border: 1px solid var(--border);
  font-size: 13px;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
}

.reaction-pill:hover {
  background: var(--accent-dim);
  border-color: var(--border-accent);
}

.reaction-pill .reaction-count {
  font-size: 11px;
  color: var(--text-muted);
}

/* â”€â”€â”€ React Picker â”€â”€â”€ */
.react-picker {
  position: absolute;
  bottom: calc(100% + 4px);
  display: none;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 6px;
  gap: 2px;
  box-shadow: var(--shadow-soft);
  z-index: 20;
}

.react-picker.show { display: flex; }

.msg.sent .react-picker { right: 0; }
.msg.received .react-picker { left: 0; }

.react-picker button {
  background: none;
  border: none;
  font-size: 20px;
  padding: 4px 6px;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.1s;
  line-height: 1;
}

.react-picker button:hover {
  background: var(--accent-dim);
}

/* â”€â”€â”€ Reply Banner â”€â”€â”€ */
.msg-reply-banner {
  padding: 6px 10px;
  margin-bottom: 4px;
  border-left: 2px solid var(--accent);
  border-radius: 2px;
  background: var(--cream-soft);
  font-size: 12px;
  color: var(--text-secondary);
  cursor: pointer;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.msg-reply-banner:hover {
  background: var(--accent-dim);
}

.msg-reply-banner .reply-author {
  color: var(--accent);
  font-weight: 500;
}

/* â”€â”€â”€ Reply Compose Indicator â”€â”€â”€ */
.reply-indicator {
  display: none;
  padding: 8px 16px;
  background: var(--bg-elevated);
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  color: var(--text-secondary);
  align-items: center;
  gap: 8px;
}

.reply-indicator.show { display: flex; }

.reply-indicator .reply-preview {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.reply-indicator .reply-preview span {
  color: var(--accent);
  font-weight: 500;
}

.reply-indicator .reply-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 16px;
  padding: 2px 6px;
  border-radius: 4px;
}

.reply-indicator .reply-close:hover {
  background: var(--cream-soft);
  color: var(--text-primary);
}

.date-divider {
  text-align: center;
  padding: 16px 0 8px;
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* â”€â”€â”€ Compose Bar â”€â”€â”€ */
.compose-bar {
  padding: 16px 28px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg-surface);
  display: flex;
  gap: 12px;
  align-items: flex-end;
}

.compose-input {
  flex: 1;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 12px 18px;
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 14.5px;
  line-height: 1.5;
  outline: none;
  resize: none;
  min-height: 44px;
  max-height: 160px;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.compose-input::placeholder { color: var(--text-muted); }

.compose-input:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}

.send-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s, opacity 0.15s;
  flex-shrink: 0;
}

.send-btn:hover { transform: scale(1.06); }
.send-btn:active { transform: scale(0.95); }
.send-btn:disabled { opacity: 0.3; cursor: default; transform: none; }

.send-btn svg {
  width: 20px;
  height: 20px;
  color: var(--bg-deep);
}

/* â”€â”€â”€ Empty State â”€â”€â”€ */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: var(--text-muted);
}

.empty-state-icon {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: var(--accent-dim);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 8px;
}

.empty-state-icon svg {
  width: 28px;
  height: 28px;
  color: var(--accent);
}

.empty-state h2 {
  font-family: var(--font-serif);
  font-size: 22px;
  color: var(--text-secondary);
  font-weight: 400;
}

.empty-state p {
  font-size: 14px;
  color: var(--text-muted);
  max-width: 280px;
  text-align: center;
}

/* â”€â”€â”€ Connection Banner â”€â”€â”€ */
.connection-banner {
  padding: 8px 20px;
  background: var(--accent-dim);
  border-bottom: 1px solid var(--border-accent);
  font-size: 13px;
  color: var(--accent);
  text-align: center;
  display: none;
}

.connection-banner.disconnected {
  display: block;
  background: rgba(220, 80, 60, 0.12);
  border-color: rgba(220, 80, 60, 0.25);
  color: #dc503c;
}

/* â”€â”€â”€ Responsive â”€â”€â”€ */
@media (max-width: 768px) {
  .app { grid-template-columns: 1fr; }
  .sidebar { display: none; }
  .sidebar.mobile-open { display: flex; position: fixed; inset: 0; z-index: 10; }
}
</style>
</head>
<body>

<div class="app" id="app">
  <!-- Left Rail -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1>Open<span>Messages</span></h1>
    </div>
    <div class="search-box">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="search-input" placeholder="Search messages..." autocomplete="off">
    </div>
    <div class="conversation-list" id="conversation-list"></div>
  </div>

  <!-- Right Pane -->
  <div class="chat-pane" id="chat-pane">
    <div class="connection-banner" id="connection-banner">
      Not connected to Google Messages
    </div>

    <!-- Empty state (shown when no conversation selected) -->
    <div class="empty-state" id="empty-state">
      <div class="empty-state-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <h2>Your messages</h2>
      <p>Select a conversation to start messaging, or wait for new messages to arrive.</p>
    </div>

    <!-- Chat view (hidden until conversation selected) -->
    <div class="chat-header" id="chat-header" style="display:none">
      <div class="chat-header-avatar" id="chat-header-avatar"></div>
      <div>
        <div class="chat-header-name" id="chat-header-name"></div>
        <div class="chat-header-status" id="chat-header-status"></div>
      </div>
    </div>
    <div class="messages-area" id="messages-area" style="display:none"></div>
    <div class="reply-indicator" id="reply-indicator">
      <div class="reply-preview">Replying to <span id="reply-to-name"></span>: <span id="reply-to-text"></span></div>
      <button class="reply-close" id="reply-close">&times;</button>
    </div>
    <div class="compose-bar" id="compose-bar" style="display:none">
      <textarea class="compose-input" id="compose-input" placeholder="Write a message..." rows="1"></textarea>
      <button class="send-btn" id="send-btn" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const API = '';
  let activeConvoId = null;
  let conversations = [];
  let pollTimer = null;

  // â”€â”€â”€ DOM refs â”€â”€â”€
  const $convoList = document.getElementById('conversation-list');
  const $emptyState = document.getElementById('empty-state');
  const $chatHeader = document.getElementById('chat-header');
  const $chatHeaderAvatar = document.getElementById('chat-header-avatar');
  const $chatHeaderName = document.getElementById('chat-header-name');
  const $chatHeaderStatus = document.getElementById('chat-header-status');
  const $messagesArea = document.getElementById('messages-area');
  const $composeBar = document.getElementById('compose-bar');
  const $composeInput = document.getElementById('compose-input');
  const $sendBtn = document.getElementById('send-btn');
  const $searchInput = document.getElementById('search-input');
  const $connectionBanner = document.getElementById('connection-banner');
  const $replyIndicator = document.getElementById('reply-indicator');
  const $replyToName = document.getElementById('reply-to-name');
  const $replyToText = document.getElementById('reply-to-text');
  const $replyClose = document.getElementById('reply-close');

  let replyToMsg = null; // {MessageID, SenderName, Body}
  const QUICK_EMOJIS = ['ðŸ˜‚', 'â¤ï¸', 'ðŸ‘', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™'];

  // â”€â”€â”€ Utilities â”€â”€â”€
  function initials(name) {
    if (!name) return '?';
    return name.split(/\s+/).map(w => w[0]).slice(0, 2).join('').toUpperCase();
  }

  function formatTime(ms) {
    if (!ms) return '';
    const d = new Date(ms);
    const now = new Date();
    const diffDays = Math.floor((now - d) / 86400000);
    if (diffDays === 0) {
      return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    } else if (diffDays === 1) {
      return 'Yesterday';
    } else if (diffDays < 7) {
      return d.toLocaleDateString([], { weekday: 'short' });
    }
    return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
  }

  function formatMessageTime(ms) {
    if (!ms) return '';
    return new Date(ms).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
  }

  function isSameDay(ms1, ms2) {
    const a = new Date(ms1), b = new Date(ms2);
    return a.getFullYear() === b.getFullYear() &&
           a.getMonth() === b.getMonth() &&
           a.getDate() === b.getDate();
  }

  function formatDateDivider(ms) {
    const d = new Date(ms);
    const now = new Date();
    const diffDays = Math.floor((now - d) / 86400000);
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    return d.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
  }

  // â”€â”€â”€ API calls â”€â”€â”€
  async function fetchJSON(url) {
    const r = await fetch(API + url);
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  async function postJSON(url, body) {
    const r = await fetch(API + url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    return r.json();
  }

  // â”€â”€â”€ Render Conversations â”€â”€â”€
  function renderConversations(convos) {
    conversations = convos;
    $convoList.innerHTML = '';
    if (!convos.length) {
      $convoList.innerHTML = '<div style="padding:40px 20px;text-align:center;color:var(--text-muted);font-size:13px">No conversations yet</div>';
      return;
    }
    convos.forEach(c => {
      const el = document.createElement('div');
      el.className = 'convo-item' + (c.ConversationID === activeConvoId ? ' active' : '');
      el.dataset.id = c.ConversationID;
      el.innerHTML = `
        <div class="convo-avatar">${initials(c.Name)}</div>
        <div class="convo-meta">
          <div class="convo-name">${escapeHtml(c.Name || 'Unknown')}</div>
          <div class="convo-preview">&nbsp;</div>
        </div>
        <div class="convo-time">${formatTime(c.LastMessageTS)}</div>
        ${c.UnreadCount > 0 ? '<div class="convo-unread"></div>' : ''}
      `;
      el.addEventListener('click', () => selectConversation(c));
      $convoList.appendChild(el);
    });
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // â”€â”€â”€ Select Conversation â”€â”€â”€
  async function selectConversation(convo) {
    activeConvoId = convo.ConversationID;

    // Update sidebar active state
    document.querySelectorAll('.convo-item').forEach(el => {
      el.classList.toggle('active', el.dataset.id === activeConvoId);
    });

    // Show chat UI
    $emptyState.style.display = 'none';
    $chatHeader.style.display = 'flex';
    $messagesArea.style.display = 'flex';
    $composeBar.style.display = 'flex';

    $chatHeaderAvatar.textContent = initials(convo.Name);
    $chatHeaderName.textContent = convo.Name || 'Unknown';
    $chatHeaderStatus.textContent = convo.IsGroup ? 'Group' : 'SMS';

    lastMsgCount = -1; // Force re-render on conversation switch
    await loadMessages(convo.ConversationID);

    // Start polling for new messages
    clearInterval(pollTimer);
    pollTimer = setInterval(() => loadMessages(activeConvoId), 3000);
  }

  // â”€â”€â”€ Load Messages â”€â”€â”€
  let lastMsgCount = 0;

  async function loadMessages(convoId) {
    try {
      const msgs = await fetchJSON(`/api/conversations/${convoId}/messages?limit=200`);
      // Reverse: API returns DESC, we want oldest first
      msgs.reverse();

      if (msgs.length === lastMsgCount && convoId === activeConvoId) return;
      lastMsgCount = msgs.length;

      const wasAtBottom = $messagesArea.scrollHeight - $messagesArea.scrollTop - $messagesArea.clientHeight < 60;

      $messagesArea.innerHTML = '';
      let lastDate = 0;

      msgs.forEach(m => {
        // Date divider
        if (!isSameDay(m.TimestampMS, lastDate)) {
          const divider = document.createElement('div');
          divider.className = 'date-divider';
          divider.textContent = formatDateDivider(m.TimestampMS);
          $messagesArea.appendChild(divider);
          lastDate = m.TimestampMS;
        }

        const el = document.createElement('div');
        el.className = 'msg ' + (m.IsFromMe ? 'sent' : 'received');

        let html = '';

        // Reply banner
        if (m.ReplyToID) {
          const original = msgs.find(om => om.MessageID === m.ReplyToID);
          const origName = original ? (original.SenderName || 'You') : '';
          const origBody = original ? (original.Body || 'Media') : 'Original message';
          html += `<div class="msg-reply-banner" data-reply-id="${escapeHtml(m.ReplyToID)}" onclick="scrollToMessage('${escapeHtml(m.ReplyToID)}')"><span class="reply-author">${escapeHtml(origName)}</span> ${escapeHtml(origBody.substring(0, 80))}</div>`;
        }

        if (!m.IsFromMe && m.SenderName) {
          html += `<div class="msg-sender">${escapeHtml(m.SenderName)}</div>`;
        }
        if (m.MediaID) {
          const isImage = (m.MimeType || '').startsWith('image/');
          if (isImage) {
            html += `<div class="msg-image-loading" id="img-loading-${m.MessageID}">Loading image...</div>`;
            html += `<img class="msg-image" src="/api/media/${encodeURIComponent(m.MessageID)}" alt="Image" style="display:none" onload="this.style.display='block';var ldr=document.getElementById('img-loading-${m.MessageID}');if(ldr)ldr.remove();" onerror="var ldr=document.getElementById('img-loading-${m.MessageID}');if(ldr)ldr.textContent='Failed to load'" onclick="showFullscreen(this.src)">`;
          } else {
            html += `<div style="font-size:13px;color:var(--text-secondary);padding:6px 0">Attachment: ${escapeHtml(m.MimeType || 'file')}</div>`;
          }
        }
        if (m.Body) {
          html += `<div class="msg-body">${escapeHtml(m.Body)}</div>`;
        }
        if (!m.Body && !m.MediaID) {
          html += `<div class="msg-body" style="color:var(--text-muted);font-style:italic">Empty message</div>`;
        }

        // Reactions
        if (m.Reactions) {
          try {
            const reactions = JSON.parse(m.Reactions);
            if (reactions.length > 0) {
              html += '<div class="msg-reactions">';
              reactions.forEach(r => {
                html += `<span class="reaction-pill" title="${r.count} reaction${r.count > 1 ? 's' : ''}">${r.emoji}<span class="reaction-count">${r.count > 1 ? r.count : ''}</span></span>`;
              });
              html += '</div>';
            }
          } catch(e) {}
        }

        html += `<div class="msg-time">${formatMessageTime(m.TimestampMS)}</div>`;

        // React picker (hidden by default, shown on hover/long-press)
        html += `<div class="react-picker" id="react-${m.MessageID}">`;
        QUICK_EMOJIS.forEach(e => {
          html += `<button onclick="sendReaction('${m.MessageID}','${e}')">${e}</button>`;
        });
        html += '</div>';

        el.innerHTML = html;
        el.dataset.msgId = m.MessageID;

        // Double-click to reply
        el.addEventListener('dblclick', (e) => {
          e.preventDefault();
          setReplyTo(m);
        });

        // Right-click (context menu) to show react picker
        el.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          // Close any other open pickers
          document.querySelectorAll('.react-picker.show').forEach(p => p.classList.remove('show'));
          const picker = document.getElementById('react-' + m.MessageID);
          if (picker) picker.classList.toggle('show');
        });

        $messagesArea.appendChild(el);
      });

      if (wasAtBottom || msgs.length !== lastMsgCount) {
        $messagesArea.scrollTop = $messagesArea.scrollHeight;
      }
    } catch (err) {
      console.error('Failed to load messages:', err);
    }
  }

  // â”€â”€â”€ Send Message â”€â”€â”€
  async function sendMessage() {
    const text = $composeInput.value.trim();
    if (!text || !activeConvoId) return;

    $composeInput.value = '';
    $sendBtn.disabled = true;
    autoResize();

    try {
      const payload = {
        conversation_id: activeConvoId,
        message: text,
      };
      if (replyToMsg) {
        payload.reply_to_id = replyToMsg.MessageID;
      }
      await postJSON('/api/send', payload);
      clearReply();
      // Reload both messages and conversations so sent-to chat jumps to top
      await loadMessages(activeConvoId);
      await loadConversations();
    } catch (err) {
      console.error('Failed to send:', err);
    }
  }

  // â”€â”€â”€ Compose Input â”€â”€â”€
  function autoResize() {
    $composeInput.style.height = 'auto';
    $composeInput.style.height = Math.min($composeInput.scrollHeight, 160) + 'px';
    $sendBtn.disabled = !$composeInput.value.trim();
  }

  $composeInput.addEventListener('input', autoResize);
  $composeInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  $sendBtn.addEventListener('click', sendMessage);

  // â”€â”€â”€ Search â”€â”€â”€
  let searchTimeout;
  $searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    const q = $searchInput.value.trim();
    if (!q) {
      loadConversations();
      return;
    }
    searchTimeout = setTimeout(async () => {
      try {
        const results = await fetchJSON(`/api/search?q=${encodeURIComponent(q)}&limit=20`);
        // Group search results by conversation
        const byConvo = {};
        results.forEach(m => {
          if (!byConvo[m.ConversationID]) {
            byConvo[m.ConversationID] = { name: m.SenderName, body: m.Body, ts: m.TimestampMS, id: m.ConversationID };
          }
        });
        const fakeConvos = Object.values(byConvo).map(c => ({
          ConversationID: c.id,
          Name: c.name || 'Unknown',
          LastMessageTS: c.ts,
        }));
        renderConversations(fakeConvos);
      } catch (err) {
        console.error('Search failed:', err);
      }
    }, 300);
  });

  // â”€â”€â”€ Status Check â”€â”€â”€
  async function checkStatus() {
    try {
      const status = await fetchJSON('/api/status');
      if (status.connected) {
        $connectionBanner.className = 'connection-banner';
      } else {
        $connectionBanner.className = 'connection-banner disconnected';
      }
    } catch {
      $connectionBanner.className = 'connection-banner disconnected';
    }
  }

  // â”€â”€â”€ Load Conversations â”€â”€â”€
  async function loadConversations() {
    try {
      const convos = await fetchJSON('/api/conversations?limit=50');
      renderConversations(convos);
    } catch (err) {
      console.error('Failed to load conversations:', err);
    }
  }

  // â”€â”€â”€ Reactions â”€â”€â”€
  window.sendReaction = async function(messageId, emoji) {
    // Close picker
    document.querySelectorAll('.react-picker.show').forEach(p => p.classList.remove('show'));
    try {
      await postJSON('/api/react', {
        message_id: messageId,
        emoji: emoji,
        conversation_id: activeConvoId,
        action: 'add',
      });
      // Reload to see updated reactions
      if (activeConvoId) await loadMessages(activeConvoId);
    } catch (err) {
      console.error('Failed to send reaction:', err);
    }
  };

  // Close react picker when clicking elsewhere
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.react-picker') && !e.target.closest('.msg')) {
      document.querySelectorAll('.react-picker.show').forEach(p => p.classList.remove('show'));
    }
  });

  // â”€â”€â”€ Reply â”€â”€â”€
  function setReplyTo(msg) {
    replyToMsg = msg;
    $replyToName.textContent = msg.SenderName || 'You';
    $replyToText.textContent = (msg.Body || 'Media').substring(0, 80);
    $replyIndicator.classList.add('show');
    $composeInput.focus();
  }

  function clearReply() {
    replyToMsg = null;
    $replyIndicator.classList.remove('show');
  }

  $replyClose.addEventListener('click', clearReply);

  window.scrollToMessage = function(msgId) {
    const el = document.querySelector(`[data-msg-id="${msgId}"]`);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      el.style.outline = '2px solid var(--accent)';
      setTimeout(() => { el.style.outline = ''; }, 1500);
    }
  };

  // â”€â”€â”€ Fullscreen Image Viewer â”€â”€â”€
  window.showFullscreen = function(src) {
    const overlay = document.createElement('div');
    overlay.className = 'msg-image-fullscreen';
    overlay.innerHTML = `<img src="${src}" alt="Full size">`;
    overlay.addEventListener('click', () => overlay.remove());
    document.body.appendChild(overlay);
  };

  // â”€â”€â”€ Init â”€â”€â”€
  loadConversations();
  checkStatus();
  setInterval(checkStatus, 10000);
  setInterval(loadConversations, 5000);
})();
</script>
</body>
</html>
